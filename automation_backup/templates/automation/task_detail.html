{% extends "base.html" %}
{% load business_filters %}

{% block title %}{{ task.project_title }}{% endblock %}

{% block content %}
<style> small{font-size: 10px ;}#taskDetailsContainer {transition: all 0.3s ease-in-out;}.kanban-list.wide {min-width: 32.5%;width: 32.5%;}.kanban-list.narrow {min-width: 24.5%;width: 24.5%;}.edit{z-index: 1;width: 30px;height: 30px;position: absolute;right: 10px;top: 10px;background: rgba(246, 248, 253, 0.7);border-radius: 4px;display: flex;justify-content: center;align-items: center;transition: .3s;}.thumbnail-container {width: 100%;height: 150px;max-height:350px;overflow: hidden;margin-bottom: 10px;}.thumbnail-image {width: 100%;height: 150px;max-height:350px;object-fit: cover;}.thumbnail-placeholder {width: 100%;height: 150px;max-height:350px;background-color: #f0f0f0;display: flex;justify-content: center;align-items: center;color: #888;font-size: 14px;}.kanban-box {display: flex;flex-direction: column;cursor:move;}.content-box {flex-grow: 1;display: flex;flex-direction: column;}.image-container {position: relative;overflow: hidden;}.thumbnail-image {width: 100%;height: 150px;max-height:350px;object-fit: cover;}.image-overlay {position: absolute;bottom: 0;left: 0;right: 0;background-color: rgba(0, 0, 0, 0.7);overflow: hidden;width: 100%;height: 0;transition: .5s ease;}.image-container:hover .image-overlay {height: 100%;}.overlay-title {color: white;font-size: 16px;position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);text-align: center;width: 90%;}.business-stats {display: flex;justify-content: space-between;margin-top: 10px;font-size: 10px;}.rank, .total-score {background-color: #f0f0f0;padding: 3px 6px;border-radius: 3px;}.kanban-cont {display: flex;overflow-x: auto;padding-bottom: 20px;}.kanban-list {min-width: 25%;width: 25%;margin-right: 10px;background-color: #f4f5f7;border-radius: 5px;}.kanban-wrap {max-height: 1200px;overflow-y: auto;}.kanban-header {margin-bottom: 10px;padding: 10px;background-color: #e4e6e9;border-radius: 5px;}.panel {margin-bottom: 10px;}.kanban-box {background-color: white;border-radius: 5px;padding: 10px;box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);}.load-more {width: 100%;margin-top: 10px;}.image-container {position: relative;width: 100%;padding-top: 56.25%;}.thumbnail-image {position: absolute;top: 0;left: 0;width: 100%;height: 100%;object-fit: cover;}.image-overlay {position: absolute;bottom: 0;left: 0;right: 0;background-color: rgba(0,0,0,0.7);overflow: hidden;width: 100%;height: 0;transition: .5s ease;}.image-container:hover .image-overlay {height: 100%;}.overlay-title {color: white;font-size: 20px;position: absolute;top: 50%;left: 50%;-webkit-transform: translate(-50%, -50%);-ms-transform: translate(-50%, -50%);transform: translate(-50%, -50%);text-align: center;}.business-title:hover::after {content: "";display: inline-block;background-image: url('');width: 150px;height: 150px;position: absolute;left: 100%;top: -10px;background-size: cover;background-position: center;box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);}</style> 
<div id="loading-spinner" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>

<div class="main-content">
 {% if user.is_admin %}
<div class="row">
<div class="col-12">
    <button id="toggleTaskDetails" class="btn btn-primary mb-3">Toggle Task Details</button>
    <div  id="taskDetailsContainer" class="box card-box">    
        <div class="icon-box {% if task.status == 'PENDING' %}bg-color-1{% elif task.status == 'IN_PROGRESS' %}bg-color-2{% elif task.status == 'COMPLETED' %}bg-color-3{% elif task.status == 'FAILED' %}bg-color-13{% endif %}">
            <div class="icon {% if task.status == 'PENDING' %}bg-icon-1{% elif task.status == 'IN_PROGRESS' %}bg-icon-2{% elif task.status == 'COMPLETED' %}bg-icon-3{% elif task.status == 'FAILED' %}bg-white{% endif %}">
                <i class="{% if task.status == 'PENDING' %}bx bxs-bell bx-tada{% elif task.status == 'IN_PROGRESS' %}bx bxs-hourglass{% elif task.status == 'COMPLETED' %}bx bxs-check-circle{% elif task.status == 'FAILED' %}bx bxs-error{% endif %}"></i>
            </div>
            <div class="content">
                <h5 class="title-box" style="    float: left;
                margin-top: -35px;
                margin-left: 60px;">{{ task.get_status_display }}</h5>
    
                <h2>{{ task.project_title }}</h2>
                <p><strong>Task ID:</strong> {{ task.id }}</p>
                <p><strong>Project ID:</strong> {{ task.project_id }}</p>
                <p><strong>Main Category:</strong> {{ task.get_main_category_display }}</p>
                {% if task.tailored_category %}
                    <p><strong>Tailored Category:</strong> {{ task.tailored_category }}</p>
                {% endif %}
                {% if task.description %}
                    <p><strong>Description:</strong> {{ task.description }}</p>
                {% endif %}
                    
                <p><strong>Created at:</strong> {{ task.created_at }}</p>
                <p><strong>Completed at:</strong> {{ task.completed_at|default:"Not completed yet" }}</p>
                
            </div>
        </div>

        <div class="icon-box bg-color-4">
            <a class="create d-flex" href="{% url 'upload_file' %}" data-toggle="modal" data-target="#add_project">
                <div class="icon bg-white">
                    <i class="bx bx-plus"></i>
                </div>
                <div class="content d-flex align-items-center">
                    <h5 class="color-white">Create New Project</h5>
                </div>
            </a>
        </div>
    </div>
</div>
</div>
 {% endif %}
<h3 class="mt-4 mb-4">Businesses Board</h3>
<p class="fs-18 font-w400 font-main mt-27 mb-29">Upon review, please ensure that each element is placed in its corresponding column. Note that the 'Move To APP' column is designated for ADMIN users only.</p>
<div class="col-12">
    <div class="row">
        <div class="col-md-3">
            <h4>Total: {{ businesses|length }}</h4>
        </div>
        <div class="col-md-3">
            <div class="mb-3">
                <input type="text" id="business-search" class="form-control" placeholder="Search businesses...">
            </div>
        </div>
        <div class="col-md-3">
            <div class="mb-3">
                <select id="business-sort" class="form-control">
                    <option value="rank">Sort by Rank</option>
                    <option value="reviews">Sort by Number of Reviews</option>
                    <option value="rating">Sort by Average Rating</option>
                </select>
            </div>
        </div>
        <div class="col-md-3">
            <div class="mb-3">
                <select id="rating-range" class="form-control">
                    <option value="">Todas las calificaciones</option>
                    <option value="5.0-4.5">5.0 - 4.5</option>
                    <option value="4.4-4.0">4.4 - 4.0</option>
                    <option value="3.9-3.5">3.9 - 3.5</option>
                    <option value="3.4-3.0">3.4 - 3.0</option>
                    <option value="2.9-0">2.9 - 0</option>
                </select>
            </div>
        </div>
    </div>
    <div class="kanban-board card mb-0 pd-0">
        <div class="box-body pd-0">
            <div class="kanban-cont">
                {% for status, status_name in status_choices %}
                {% if status != 'IN_PRODUCTION' or user.is_admin %}
                <div class="kanban-list {% if status == 'DISCARDED' %} kanban-list-discarded {% else %} {% if user.is_admin %}narrow{% else %}wide{% endif %} {% endif %}" id="{{ status }}">
                    <div id="{{status}}" class="kanban-header">
                        <h6 id="{{ status }}" class="card-title {% if status == 'DISCARDED' %} text-danger {% endif %}">
                            {% if status == 'IN_PRODUCTION' %}
                            Move To APP
                            {% else %}
                            {{ status_name }} (<span class="status-count" data-status="{{ status }}">{{ businesses|filter_by_status:status|length }}</span>)
                            {% endif %}
 
                        </h6>
                    </div>
                    <div class="kanban-wrap" id="kanban-wrap-{{ status }}">
                        {% for business in businesses|filter_by_status:status %}
                        {% if business.status == status %}
                        <div class="panel" data-id="{{ business.id }}" data-status="{{ business.status }}">
                            <div class="kanban-box item-box">
                                <div class="dropdown edit">
                                    <a href="#" class="btn-link" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-pencil-alt"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        <a class="dropdown-item" href="{% url 'business_detail' business.id %}">
                                            <i class="bx bx-show mr-5"></i>View
                                        </a>
                                        <!--<a class="dropdown-item" href="#" data-toggle="modal" data-target="#edit_card_modal">
                                            <i class="bx bx-edit mr-5"></i>Edit
                                        </a>-->
                                    </div>
                                </div>
    
                                <!-- Title Box -->
                                <div class="title-box">
                                    <strong class="business-title">
                                        <a class="dropdown-item" href="{% url 'business_detail' business.id %}">
                                            {{ business.title|truncatechars:15 }}
                                         </a>
                                    </strong>
                                </div>
    
                                <div class="content-box">
                                    <small class="">
                                        <a href="https://www.google.com/maps/place/?q=place_id:{{ business.place_id }}" class="" target="_blank">
                                            <i class="bx bx-pin font-size-16 align-middle me-1"></i>{{ business.address }}
                                        </a>
                                    </small>
                                    <span class="badge badge-success">{{ business.category_name }}</span>            
                                        <div class="business-stats">
                                            <span class="rank">Rank: {{ business.rank|default:"N/A" }}</span>
                                            <span class="total-score">Total Score: {{ business.reviews_count|default:"N/A" }}</span>
                                            <span class="total-score">Avg: {{ business.rating|default:"N/A" }}</span>
                                        </div>
                                        </div>
                                        </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                        </div>
                                        </div>
                                        {% endif %}
                                        {% endfor %}
                                        </div>
                                        </div>
                                        </div>
    
      
</div>
 
{% if not businesses %}
    <p>No businesses found for this project.</p>
{% endif %}

    {% if not businesses %}
        <p>No businesses found for this project.</p>
    {% endif %}
    
    <a href="{% url 'upload_file' %}" class="btn btn-secondary mt-3">Back to Projects</a>
    <button id="scroll-to-top" class="btn btn-primary" style="display: none; position: fixed; bottom: 20px; right: 30px; z-index: 99;">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var containers = document.querySelectorAll('.kanban-wrap');
    containers.forEach(function(container) {
        new Sortable(container, {
            group: 'shared',
            animation: 150,
            onEnd: function(evt) {
                var itemEl = evt.item;
                var newStatus = evt.to.closest('.kanban-list').id;
                var oldStatus = evt.from.closest('.kanban-list').id;
                var businessId = itemEl.dataset.id;

                // Only proceed if the status has changed
                if (newStatus !== oldStatus) {
                    // Update the status in the backend
                    updateBusinessStatus(businessId, newStatus, oldStatus);
                }
            }
        });
    });
});

function updateBusinessStatus(businessId, newStatus, oldStatus) {
    fetch(`/update-business-status/${businessId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Actualizar los contadores
            updateStatusCount(oldStatus, -1);
            updateStatusCount(newStatus, 1);
            // Actualizar el atributo data-status del elemento movido
            document.querySelector(`.panel[data-id="${businessId}"]`).dataset.status = newStatus;
        } else {
            alert('Error updating business status: '  + (data.message || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the business status');
    });
}

function updateStatusCount(status, newCount) {
    var countElement = document.querySelector(`.status-count[data-status="${status}"]`);
    if (countElement) {
        countElement.textContent = newCount;
    }
}

function updateStatusCount(status, change) {
    var countElement = document.querySelector(`.status-count[data-status="${status}"]`);
    if (countElement) {
        var currentCount = parseInt(countElement.textContent);
        countElement.textContent = currentCount + change;
    }
}


// Función para obtener el token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        var kanbanLists = document.querySelectorAll('.kanban-wrap');
        
        kanbanLists.forEach(function(list) {
            new Sortable(list, {
                group: 'shared',
                animation: 150,
                onEnd: function(evt) {
                var itemEl = evt.item;
                var newStatus = evt.to.closest('.kanban-list').id;
                var oldStatus = evt.from.closest('.kanban-list').id;
                var businessId = itemEl.dataset.id;
                updateBusinessStatus(businessId, newStatus, oldStatus);
            }

            });
        });
    
        function updateBusinessStatus(businessId, newStatus) {
            fetch(`/update-business-status/${businessId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `status=${newStatus}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log(`Business ${businessId} status updated to ${newStatus}`);
                } else {
                    console.error('Error updating business status');
                    // You might want to move the item back to its original position here
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    
        function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButton = document.getElementById('toggleTaskDetails');
        const taskDetailsContainer = document.getElementById('taskDetailsContainer');
        
        // Get the saved state from localStorage, default to true if not set
        let isVisible = localStorage.getItem('taskDetailsVisible') !== 'false';
        
        // Set initial state based on saved preference
        if (!isVisible) {
            taskDetailsContainer.style.display = 'none';
            toggleButton.textContent = 'Show Task Details';
        }
        
        toggleButton.addEventListener('click', function() {
            if (isVisible) {
                taskDetailsContainer.style.display = 'none';
                toggleButton.textContent = 'Show Task Details';
            } else {
                taskDetailsContainer.style.display = 'block';
                toggleButton.textContent = 'Hide Task Details';
            }
            isVisible = !isVisible;
            
            // Save the new state to localStorage
            localStorage.setItem('taskDetailsVisible', isVisible);
        });
    });
</script>
<script>
    $(document).ready(function() {
        // Existing functionalities...
    
        // Sorting functionality
        $('#business-sort').change(function() {
            var sortBy = $(this).val();
            $('.kanban-wrap').each(function() {
                var $wrap = $(this);
                var $businesses = $wrap.find('.panel').get();
                $businesses.sort(function(a, b) {
                    var aValue, bValue;
                    if (sortBy === 'rank') {
                        aValue = parseInt($(a).find('.rank').text().split(':')[1]) || 0;
                        bValue = parseInt($(b).find('.rank').text().split(':')[1]) || 0;
                    } else if (sortBy === 'reviews') {
                        aValue = parseInt($(a).find('.total-score').first().text().split(':')[1]) || 0;
                        bValue = parseInt($(b).find('.total-score').first().text().split(':')[1]) || 0;
                    } else if (sortBy === 'rating') {
                        aValue = parseFloat($(a).find('.total-score').last().text().split(':')[1]) || 0;
                        bValue = parseFloat($(b).find('.total-score').last().text().split(':')[1]) || 0;
                    }
                    return bValue - aValue; // Sort in descending order
                });
                $.each($businesses, function(idx, item) { $wrap.append(item); });
            });
        });
    });
</script>
<script>
    $(document).ready(function() {
        $('.load-more').click(function() {
            var button = $(this);
            var status = button.data('status');
            var page = button.data('page');
            
            $('#loading-spinner').show();
            
            $.ajax({
                url: '{% url "load_more_businesses" %}',
                data: {
                    'status': status,
                    'page': page,
                    'task_id': '{{ task.id }}'
                },
                success: function(data) {
                    $('#kanban-wrap-' + status).append(data.html);
                    if (data.has_more) {
                        button.data('page', page + 1);
                    } else {
                        button.hide();
                    }
                    $('#loading-spinner').hide();
                },
                error: function() {
                    alert('Error loading more businesses. Please try again.');
                    $('#loading-spinner').hide();
                }
            });
        });
    });
</script>
<script>
    $(document).ready(function() {
        // Existing load-more functionality...
    
        // Scroll to top functionality
        $(window).scroll(function() {
            if ($(this).scrollTop() > 100) {
                $('#scroll-to-top').fadeIn();
            } else {
                $('#scroll-to-top').fadeOut();
            }
        });
    
        $('#scroll-to-top').click(function() {
            $('html, body').animate({scrollTop : 0}, 800);
            return false;
        });
    
        // Smooth scrolling for kanban lists
        $('.kanban-wrap').scroll(function() {
            if ($(this).scrollTop() > 100) {
                $(this).find('.scroll-to-top').fadeIn();
            } else {
                $(this).find('.scroll-to-top').fadeOut();
            }
        });
    
        $('.scroll-to-top').click(function() {
            $(this).closest('.kanban-wrap').animate({scrollTop : 0}, 800);
            return false;
        });
    });
</script>
<script>
    $(document).ready(function() {
        // Existing functionalities...
    
        // Search functionality
        $('#business-search').on('input', function() {
            var searchTerm = $(this).val().toLowerCase();
            $('.panel').each(function() {
                var businessTitle = $(this).find('.overlay-title').text().toLowerCase();
                var businessAddress = $(this).find('.content-box p').text().toLowerCase();
                if (businessTitle.includes(searchTerm) || businessAddress.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });
    });
</script>
 

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const translatingButtons = document.querySelectorAll('.start-translating-btn');
        
        translatingButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (this.classList.contains('disabled')) {
                    return;
                }
                
                this.classList.add('disabled');
                this.textContent = 'Translating and Enhancing...';
                
                const taskId = this.getAttribute('data-task-id');
                
                fetch(`/tasks/${taskId}/translate/`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        this.textContent = 'Translation and Enhancement Complete';
                    } else {
                        this.textContent = 'Error Translating and Enhancing';
                        this.classList.remove('disabled');
                    }
                    console.log(data.message);
                })
                .catch(error => {
                    console.error('Error:', error);
                    this.textContent = 'Error Translating and Enhancing';
                    this.classList.remove('disabled');
                });
            });
        });
    
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
    </script>
<script>
    $(document).ready(function() {
    // Función para filtrar negocios por rango de calificación
    function filterBusinessesByRating(minRating, maxRating) {
        $('.panel').each(function() {
            var avgRating = parseFloat($(this).find('.total-score').last().text().split(':')[1]) || 0;
            if (avgRating >= minRating && avgRating <= maxRating) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }

    // Evento para el cambio en el selector de rango de calificación
    $('#rating-range').change(function() {
        var range = $(this).val();
        if (range) {
            var [maxRating, minRating] = range.split('-').map(Number);
            filterBusinessesByRating(minRating, maxRating);
        } else {
            $('.panel').show(); // Mostrar todos si no hay rango seleccionado
        }
    });

    // Código existente para ordenar...
    $('#business-sort').change(function() {
        var sortBy = $(this).val();
        $('.kanban-wrap').each(function() {
            var $wrap = $(this);
            var $businesses = $wrap.find('.panel').get();
            $businesses.sort(function(a, b) {
                var aValue, bValue;
                if (sortBy === 'rank') {
                    aValue = parseInt($(a).find('.rank').text().split(':')[1]) || 0;
                    bValue = parseInt($(b).find('.rank').text().split(':')[1]) || 0;
                } else if (sortBy === 'reviews') {
                    aValue = parseInt($(a).find('.total-score').first().text().split(':')[1]) || 0;
                    bValue = parseInt($(b).find('.total-score').first().text().split(':')[1]) || 0;
                } else if (sortBy === 'rating') {
                    aValue = parseFloat($(a).find('.total-score').last().text().split(':')[1]) || 0;
                    bValue = parseFloat($(b).find('.total-score').last().text().split(':')[1]) || 0;
                }
                return bValue - aValue; // Ordenar en orden descendente
            });
            $.each($businesses, function(idx, item) { $wrap.append(item); });
        });
    });

    // Código existente para búsqueda...
    $('#business-search').on('input', function() {
        var searchTerm = $(this).val().toLowerCase();
        $('.panel').each(function() {
            var businessTitle = $(this).find('.overlay-title').text().toLowerCase();
            var businessAddress = $(this).find('.content-box p').text().toLowerCase();
            if (businessTitle.includes(searchTerm) || businessAddress.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });

    // Función para aplicar todos los filtros
    function applyAllFilters() {
        var searchTerm = $('#business-search').val().toLowerCase();
        var ratingRange = $('#rating-range').val();
        var [maxRating, minRating] = ratingRange ? ratingRange.split('-').map(Number) : [5, 0];

        $('.panel').each(function() {
            var businessTitle = $(this).find('.overlay-title').text().toLowerCase();
            var businessAddress = $(this).find('.content-box p').text().toLowerCase();
            var avgRating = parseFloat($(this).find('.total-score').last().text().split(':')[1]) || 0;

            var matchesSearch = businessTitle.includes(searchTerm) || businessAddress.includes(searchTerm);
            var matchesRating = avgRating >= minRating && avgRating <= maxRating;

            if (matchesSearch && matchesRating) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    }

    // Aplicar todos los filtros cuando cambie cualquier criterio
    $('#business-search, #rating-range').on('input change', applyAllFilters);

    // Aplicar ordenamiento después de los filtros
    $('#business-sort').change(function() {
        var sortBy = $(this).val();
        $('.kanban-wrap').each(function() {
            var $wrap = $(this);
            var $businesses = $wrap.find('.panel:visible').get();
            $businesses.sort(function(a, b) {
                var aValue, bValue;
                if (sortBy === 'rank') {
                    aValue = parseInt($(a).find('.rank').text().split(':')[1]) || 0;
                    bValue = parseInt($(b).find('.rank').text().split(':')[1]) || 0;
                } else if (sortBy === 'reviews') {
                    aValue = parseInt($(a).find('.total-score').first().text().split(':')[1]) || 0;
                    bValue = parseInt($(b).find('.total-score').first().text().split(':')[1]) || 0;
                } else if (sortBy === 'rating') {
                    aValue = parseFloat($(a).find('.total-score').last().text().split(':')[1]) || 0;
                    bValue = parseFloat($(b).find('.total-score').last().text().split(':')[1]) || 0;
                }
                return bValue - aValue; // Ordenar en orden descendente
            });
            $.each($businesses, function(idx, item) { $wrap.append(item); });
        });
    });
});


</script>   
{% endblock %}