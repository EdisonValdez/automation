<!-- templates/automation/business_detail.html -->
{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}{{ business.title }}{% endblock %}
{% block content %}
<style>.description-content {white-space: pre-wrap;font-family: inherit; line-height: 1.6;}.card-body{-webkit-box-flex:1;-ms-flex:1 1 auto;flex:1 1 auto;padding:.25rem}.box-list li{display:flex;color:var(--text-color);margin-bottom:18px;font-size:14px;font-weight:400;align-items:center}span{font-style:bold}.checkbox-container{display:flex;align-items:center;gap:10px}.approve-checkbox{width:40px;height:40px;cursor:pointer;accent-color:#3C21F7;border:2px solid #666;border-radius:4px;outline:none;transition:all 0.3s ease}.approve-checkbox:hover{transform:scale(1.1);border-color:#4CAF50}.approve-checkbox:focus{box-shadow:0 0 0 3px rgb(76 175 80 / .3)}.checkbox-container strong{font-size:16px;color:#333;user-select:none}.image-card{padding:15px;border:1px solid #ddd;border-radius:8px;margin-bottom:15px}.translation{max-height:250px;overflow-y:auto}.form-label{text-transform:uppercase;font-weight:900;color:#060606;border-radius:calc(.25rem - 1px) calc(.25rem - 1px) 0 0;background-color:#fff;background-clip:border-box;border:1px solid rgb(0 0 0 / .125);width:100%;padding:.75rem 1.25rem;background-color:rgb(0 0 0 / .03);border-bottom:1px solid rgb(0 0 0 / .125)}.business-title{font-weight:900}.bd-callout-info{border-left-color:#5bc0de}.bd-callout{padding:1.25rem;margin-top:1.25rem;margin-bottom:1.25rem;border:1px solid #e9ecef;border-left-width:.25rem;border-radius:.25rem}.image-management-container{display:flex;justify-content:center;padding:10px}.image-container{width:100%;padding:15px;min-height:300px}.images-wrapper{display:flex;flex-wrap:wrap;gap:30px}.image-card{position:relative;display:flex;flex-direction:column;align-items:center;width:250px;min-height:200px;padding:7px;border:1px solid #ccc;border-radius:8px;background-color:#fff;cursor:grab}.thumbnail{width:100%;height:auto;object-fit:cover;border-radius:5px}.checkbox-container{margin-top:5px}.draggable.dragging{opacity:.5}.delete-image-btn{margin-top:10px;padding:5px 10px;background-color:#dc3545;border:none;color:#fff;border-radius:5px;cursor:pointer}small{font-size:10px}#taskDetailsContainer{transition:all 0.3s ease-in-out}.kanban-list.wide{min-width:32.5%;width:32.5%}.kanban-list.narrow{min-width:24.5%;width:24.5%}.edit{z-index:1;width:30px;height:30px;position:absolute;right:10px;top:10px;background:rgb(246 248 253 / .7);border-radius:4px;display:flex;justify-content:center;align-items:center;transition:.3s}.thumbnail-container{width:100%;height:150px;max-height:350px;overflow:hidden;margin-bottom:10px}.thumbnail-image{width:100%;height:150px;max-height:350px;object-fit:cover}.thumbnail-placeholder{width:100%;height:150px;max-height:350px;background-color:#f0f0f0;display:flex;justify-content:center;align-items:center;color:#888;font-size:14px}.kanban-box{display:flex;flex-direction:column;cursor:move}.content-box{flex-grow:1;display:flex;flex-direction:column}.image-container{position:relative;overflow:hidden}.thumbnail-image{width:100%;height:150px;max-height:350px;object-fit:cover}.image-overlay{position:absolute;bottom:0;left:0;right:0;background-color:rgb(0 0 0 / .7);overflow:hidden;width:100%;height:0;transition:.5s ease}.image-container:hover .image-overlay{height:100%}.overlay-title{color:#fff;font-size:16px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;width:90%}.business-stats{display:flex;justify-content:space-between;margin-top:10px;font-size:10px}.rank,.total-score{background-color:#f0f0f0;padding:3px 6px;border-radius:3px}.kanban-cont{display:flex;overflow-x:auto;padding-bottom:20px}.kanban-list{min-width:25%;width:25%;margin-right:10px;background-color:#f4f5f7;border-radius:5px}.kanban-wrap{max-height:1200px;overflow-y:auto}.kanban-header{margin-bottom:10px;padding:10px;background-color:#e4e6e9;border-radius:5px}.panel{margin-bottom:10px}.kanban-box{background-color:#fff;border-radius:5px;padding:10px;box-shadow:0 1px 3px rgb(0 0 0 / .12),0 1px 2px rgb(0 0 0 / .24)}.load-more{width:100%;margin-top:10px}.image-container{position:relative;width:100%;padding-top:5%}.thumbnail-image{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover}.image-overlay{position:absolute;bottom:0;left:0;right:0;background-color:rgb(0 0 0 / .7);overflow:hidden;width:100%;height:0;transition:.5s ease}.image-container:hover .image-overlay{height:100%}.overlay-title{color:#fff;font-size:20px;position:absolute;top:50%;left:50%;-webkit-transform:translate(-50%,-50%);-ms-transform:translate(-50%,-50%);transform:translate(-50%,-50%);text-align:center}.business-title:hover::after{content:"";display:inline-block;background-image:url('');width:150px;height:150px;position:absolute;left:100%;top:-10px;background-size:cover;background-position:center;box-shadow:0 4px 8px rgb(0 0 0 / .1)}</style>
<!--Main content--> 
<div class="main-container">
<!--box left-dot-->
<div class="box left-dot">
    <div class="row mt-18">  
        <div class="col-9 mt-25">
            <div class="mt-25">
                <div class="bd-callout bd-callout-info">
                    <h4 class="title-box"><label class="title-box"> <i class="fas fa-pencil-alt"></i> {{ business.title }}</label> <button id="feedback-button" class="btn btn-primary btn-sm ms-3">
                        <i class="fas fa-comments"></i> Feedback
                    </button></h4> 
                </div> 
             </div>
        </div>   
        <div class="col-3 mt-25">
            <div class="mt-25">
                <!-- Navigation Buttons -->
                <div class="navigation-buttons mt-25">
                    {% if prev_url %}
                    <a href="{{ prev_url }}" class="btn btn-link">
                        <i class="fas fa-chevron-left"></i> Previous
                    </a>
                    {% endif %}

                    {% if next_url %}
                    <a href="{{ next_url }}" class="btn btn-link">
                        Next <i class="fas fa-chevron-right"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>  
    </div>
    <form id="business-form" method="post" action="{% url 'update_business' business.id %}">
        {% csrf_token %} 
        <div class="row">        
            <div class="col-xl-9 col-lg-9 col-md-6 col-sm-12">
                <div class="box left-dot">
                    <div class="row gy-3">
                        <!-- Business Title -->
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <label class="form-label"> 
                            <i class="fas fa-briefcase me-2"></i> Business Title</label>
                            <div class="card-body d-flex align-items-center">
                                <span id="title-display">{{ business.title }}</span><br>
                                <input type="text" name="title" id="title-edit" class="form-control ms-2" value="{{ business.title }}" style="display:none;">
                                <button type="button" class="btn btn-link ms-2" onclick="toggleEdit('title')">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                        </div>
                    
                        <!-- Status -->
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <label class="form-label"> 
                            <i class="fas fa-info-circle me-2"></i> Status</label>
                            <div class="card-body d-flex align-items-center">
                                <span id="status-display" style="display: none;">{{ business.get_status_display }}</span><br>
                                <select name="status" id="status-edit" class="form-control ms-2">
                                    {% for status_code, status_name in status_choices %}
                                        {% if status_code != "IN_PRODUCTION" %}
                                            <option value="{{ status_code }}" {% if business.status == status_code %}selected{% endif %}>
                                                {{ status_name }}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                                
                                
                                <button type="button" class="btn btn-link ms-2" onclick="toggleEdit('status')">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                        </div>
                    
                        <!-- City -->
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <label class="form-label"> 
                            <i class="fas fa-map-marker-alt me-2"></i> Destination</label>
                            <div class="card-body d-flex align-items-center">
                                <span id="city-display">{{ business.city|default:"N/A" }}</span><br>
                                <input type="text" name="city" id="city-edit" class="form-control ms-2" value="{{ business.city }}" style="display:none;">
                                <button type="button" class="btn btn-link ms-2" onclick="toggleEdit('city')">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                        </div>
                    
                        <!-- Price -->
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <label class="form-label">
                                <i class="fas fa-dollar-sign me-2"></i> Price</label>
                            <div class="card-body d-flex align-items-center">
                                <span id="price-display">{{ business.price|default:"N/A" }}</span>
                                <input type="text" name="price" id="price-edit" class="form-control ms-2" value="{{ business.price }}" style="display:none;">
                                <button type="button" class="btn btn-link ms-2" onclick="toggleEdit('price')">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                        </div>
                    
                        <!-- Website -->
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <label class="form-label">
                                <i class="fas fa-globe me-2"></i> Website</label>
                            <div class="card-body d-flex align-items-center">
                                {% if business.website %}
                                <span id="website-display">{{ business.website|truncatechars:20  }}</span>
                                <input type="text" name="website" id="website-edit" class="form-control ms-2" value="{{ business.website }}" style="display:none;">
                                <button type="button" class="btn btn-link ms-2" onclick="toggleEdit('website')">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </div>
                        </div>
                        
                    
                        <!-- Phone Number -->
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <label class="form-label">
                                <i class="fas fa-phone me-2"></i> Phone Number</label>
                            <div class="card-body d-flex align-items-center">
                                {% if business.phone %}
                                <span id="phone-display">{{ business.phone }}</span>
                                <input type="text" name="phone" id="phone-edit" class="form-control ms-2" value="{{ business.phone }}" style="display:none;">
                                <button type="button" class="btn btn-link ms-2" onclick="toggleEdit('phone')">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </div>
                        </div>

                         <!-- Address -->
                         <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <label class="form-label">
                                <i class="fas fa-road me-2"></i> Address</label>
                            <div class="card-body d-flex align-items-center">
                                {% if business.address %}
                                <span id="address-display">{{ business.address }}</span>
                                <input type="text" name="address" id="address-edit" class="form-control ms-2" value="{{ business.address }}" style="display:none;">
                                <button type="button" class="btn btn-link ms-2" onclick="toggleEdit('address')">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Level Title -->
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <label class="form-label">
                                <i class="fas fa-tree me-2"></i> Level Title</label>
                            <div class="card-body d-flex align-items-center">
                                {% if business.level_title %}
                                <span id="level_title-display">{{ business.level_title }}</span>
                                <input type="text" name="level_title" id="level_title-edit" class="form-control ms-2" value="{{ business.level_title }}" style="display:none;">
                                
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </div>
                        </div>
                    
                        <!-- Main Categories -->
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <label class="form-label">
                                <i class="fas fa-list-ul me-2"></i> Main Categories</label>
                            <div class="card-body d-flex align-items-center">
                                <span id="main_category-display">
                                    
                                </span>
                                <select name="main_category" id="main_category-edit" class="form-control ms-2 select2" style="display:none;" multiple>
                                    {% with business.main_category|split_by_comma as selected_main_categories %}
                                    {% for category in main_categories %}
                                    <option value="{{ category.title }}" {% if category.title in selected_main_categories %}selected{% endif %}>
                                        {{ category.title }}
                                    </option>
                                    {% endfor %}
                                    {% endwith %}
                                </select>
                                <button type="button" class="btn btn-link ms-2" onclick="toggleEdit('main_category')">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                        </div>
                    
                        <!-- Tailored Categories -->
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <label class="form-label">
                                <i class="fas fa-tags me-2"></i> Sub-Categories</label>
                            <div class="card-body d-flex align-items-center">
                                <span id="tailored_category-display">
                                 
                                </span>
                                <select name="tailored_category" id="tailored_category-edit" class="form-control ms-2 select2" style="display:none;" multiple>
                                    {% with business.tailored_category|split_by_comma as selected_tailored_categories %}
                                    {% for category in subcategories %}
                                    <option value="{{ category.title }}" {% if category.title in selected_tailored_categories %}selected{% endif %}>
                                        {{ category.title }}
                                    </option>
                                    {% endfor %}
                                    {% endwith %}
                                </select>
                                <button type="button" class="btn btn-link ms-2" onclick="toggleEdit('tailored_category')">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                        </div>
                     
                        <!-- Types -->
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <label class="form-label">
                                <i class="fas fa-shapes me-2"></i> Google Types</label>
                            <div class="card-body d-flex align-items-center">
                                <span id="types-display">{{ business.types|default:"N/A" }}</span>
                                <input type="text" name="types" id="types-edit" class="form-control ms-2" value="{{ business.types }}" style="display:none;">
                                <button type="button" class="btn btn-link ms-2" onclick="toggleEdit('types')">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                        </div>
                    
                        <!-- Latitude -->
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <label class="form-label">
                                <i class="fas fa-map-marker me-2"></i> Longitude</label>
                            <div class="card-body d-flex align-items-center">
                                <span id="latitude-display">{{ business.latitude|default:"N/A" }}</span>
                                <input type="text" name="latitude" id="latitude-edit" class="form-control ms-2" value="{{ business.latitude }}" style="display:none;">
                                <button type="button" class="btn btn-link ms-2" onclick="toggleEdit('latitude')">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                        </div>
                    
                        <!-- Longitude -->
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <label class="form-label">
                                <i class="fas fa-map-marker me-2"></i> Longitude</label>
                            <div class="card-body d-flex align-items-center">
                                <span id="longitude-display">{{ business.longitude|default:"N/A" }}</span>
                                <input type="text" name="longitude" id="longitude-edit" class="form-control ms-2" value="{{ business.longitude }}" style="display:none;">
                                <button type="button" class="btn btn-link ms-2" onclick="toggleEdit('longitude')">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>         
            <div class="col-xl-3 col-lg-3 col-md-6 col-sm-12">
                <div class="box left-dot">
                    <div class="box-body">
                        <!-- Service Options Button -->
                        <div class="row gy-3">
                            <div class="col-md-12">
                                <label class="form-label">
                                    <i class="fas fa-concierge-bell me-2"></i> Service Options
                                </label>
                                {% if business.service_options %}
                                    <button type="button" class="btn btn-outline-primary btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#serviceOptionsModal">
                                        <i class="fas fa-eye me-1"></i> View Service Options
                                    </button>
                                {% else %}
                                    <br>
                                    <p>No service options available.</p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Service Options Modal -->
                        {% if business.service_options %}
                        <div class="modal fade" id="serviceOptionsModal" tabindex="-1" aria-labelledby="serviceOptionsModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="serviceOptionsModalLabel">
                                            <i class="fas fa-concierge-bell me-2"></i> Service Options for {{ business.title }}
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row">
                                            {% for category in business.service_options %}
                                                {% for category_name, options in category.items %}
                                                    <div class="col-md-3 mb-4">
                                                        <div class="service-category">
                                                            <h6 class="text-primary">
                                                                <i class="fas fa-info-circle me-2"></i>
                                                                {{ category_name|title }}
                                                            </h6>
                                                            <ul class="list-unstyled ms-4">
                                                                {% for option in options %}
                                                                    <li class="mb-1">
                                                                        <i class="fas fa-check text-success me-2"></i>
                                                                        {{ option }}
                                                                    </li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                    </div>
                                                {% endfor %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Operating Hours -->
                        <div class="row gy-3">
                            <div class="col-md-12">
                                <label class="form-label">
                                    <i class="fas fa-clock me-2"></i> Operating Hours
                                </label>
                                {% if business.operating_hours %}
                                <button type="button" class="btn btn-link" onclick="editOperatingHours()">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <ul class="card-body box-list mt-3">
                                    {% for day, hours in business.operating_hours.items %}
                                    <li class="d-flex align-items-center">
                                        <div id="{{ day }}_display" class="flex-grow-1">
                                            <strong>{{ day|title }}:</strong> {{ hours }}
                                        </div>
                                        <input type="text" name="operating_hours[{{ day }}]" id="{{ day }}_edit" class="form-control ms-2" value="{{ hours }}" style="display:none;">
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <p>No Operating Hours available.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>            
        </div>
             
        <div class="row">            
            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12">
                <!-- Description (Original) -->
                <div class="left-dot">
                    <div class="card box-body translation">
                        <div class="card-header business-title">Description <img src="{% static 'images/flags/us.jpg'%}" width="25px" />
                            <button type="button" class="btn btn-link" onclick="toggleEdit('description')">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            {% if not business.description or business.description == 'None' %}
                                <button title="Generate description" type="button" class="btn btn-primary" id="generate-description-btn" onclick="generateDescription({{ business.id }})">
                                    <i class="fa-solid fa-indent"></i>
                                </button>
                            {% else %}
                    
                                <button title="Enhance & Translate Description" type="button" class="btn btn-link" onclick="enhanceAndTranslateDescription({{ business.id }})">
                                    <i class="fas fa-language"></i> Enhance & Translate
                                </button>
                            {% endif %}
                            </div>
                            <div class="card-body">
                        <p id="description-display" class="description-content">{{ business.description|default:"No description available." }}</p>
                        <textarea name="description" id="description-edit" class="form-control" style="display:none;">{{ business.description }}</textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12">
            <!-- Description (UK) -->
            <div class="left-dot">
                    <div class="card box-body translation">
                        <div class="card-header business-title">Description  <img src="{% static 'images/flags/uk.jpg'%}" width="25px" />
                            <button type="button" class="btn btn-link" onclick="toggleEdit('description-eng')">
                                <i id="description-eng-toggle-icon" class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                        <div class="card-body">
                        <p id="description-eng-display" class="description-content">{{ business.description_eng|default:"No description available." }}</p>
                        <textarea name="description_eng" id="description-eng-edit" class="form-control" style="display:none;">{{ business.description_eng }}</textarea>
                    </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-4 col-lg-4 col-md-6 col-sm-12"> 
                <!-- Description (Spanish) -->
                <div class="left-dot">
                    <div class="card box-body translation">
                        <div class="card-header business-title">Description  <img src="{% static 'images/flags/spain.jpg'%}" width="25px" />
                            <button type="button" class="btn btn-link" onclick="toggleEdit('description-esp')">
                                <i id="description-esp-toggle-icon" class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                        <div class="card-body">
                        <p id="description-esp-display" class="description-content">{{ business.description_esp|default:"No description available." }}</p>
                        <textarea name="description_esp" id="description-esp-edit" class="form-control" style="display:none;">{{ business.description_esp }}</textarea>
                        </div>
                    </div>
                </div>
            </div>                 
        </div>           
 
        <div class="box-body">
            <button type="submit" class="btn btn-danger mt-3">
                <i class="fas fa-save"></i> Save Changes
            </button>
            {% if business.place_id %}
            <a href="https://www.google.com/maps/place/?q=place_id:{{ business.place_id }}" class="btn btn-primary mt-3" target="_blank">
                <i class="fas fa-map-marked-alt"></i> View on Google Maps
            </a>
            {% endif %}
            <a href="{% url 'task_detail' business.task.id %}" class="btn btn-secondary mt-3">
                <i class="fas fa-arrow-left"></i> Back to Task
            </a>
        </div>
        
        <div class="mt-25">
            <!-- Navigation Buttons -->
            <div class="navigation-buttons">
                {% if prev_url %}
                <a href="{{ prev_url }}" class="btn btn-link">
                    <i class="fas fa-chevron-left"></i> Previous
                </a>
                {% endif %}

                {% if next_url %}
                <a href="{{ next_url }}" class="btn btn-link">
                    Next <i class="fas fa-chevron-right"></i>
                </a>
                {% endif %}
            </div>
        </div>  
    </form>   
</div> 
<!--box left-dot-->      
 
<!-- Loading Modal -->
<div id="loading-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="spinner"></div>
        <p>Generating description, please wait...</p>
    </div>
</div>
<!-- Loading Modal -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Image Management Container -->
<div class="box image-management-container">
    <div class="box left-dot">
        <div class="box-body">
            <div class="image-container single-container">
                <h3 class="mb-30">Images</h3>
                <div class="images-wrapper" id="image-list">
                    {% for image in business.images.all %}
                    <div class="image-card draggable" data-id="{{ image.id }}" data-approved="{{ image.is_approved }}" draggable="true">
                        <div class="checkbox-container mb-25" style="cursor: pointer;">
                            <strong>Approve</strong>
                            <input type="checkbox" class="approve-checkbox" data-id="{{ image.id }}" {% if image.is_approved %}checked{% endif %}>
                        </div>

                        <img class="thumbnail"
                            src="{% if image.local_path %}{{ MEDIA_URL }}{{ image.local_path }}{% else %}{{ image.image_url }}{% endif %}"
                            alt="Image"> 
                        <!-- Add Delete Button -->
                        <button class="btn btn-danger delete-image-btn" data-id="{{ image.id }}">Delete</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div> 
<!--box image-management-container-->

</div>
<!--Main content--> 

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  
<!--UPDATE BUSINESS STATUS with change-business-status-->
 <!-- JavaScript code for changing business status -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const businessId = '{{ business.id }}';
    const statusDisplay = document.getElementById('status-display');

    // For status options (e.g., buttons or links)
    const statusOptions = document.querySelectorAll('.status-option');

    statusOptions.forEach(option => {
        option.addEventListener('click', function () {
            const newStatus = this.getAttribute('data-status');
            updateStatus(businessId, newStatus, statusDisplay);
        });
    });

    // For status dropdown (if used)
    const statusDropdown = document.getElementById('status-edit');
    if (statusDropdown) {
        statusDropdown.addEventListener('change', function () {
            const newStatus = this.value;
            updateStatus(businessId, newStatus, statusDisplay, statusDropdown);
        });
    }

    // Helper function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Helper function to check if a description is empty or "None"
    function isDescriptionEmpty(description) {
        return !description || description.trim() === '' || description.trim().toLowerCase() === 'none';
    }

    // Function to update the business status
    function updateStatus(businessId, newStatus, statusDisplay, statusDropdown = null) {
    // Fetch current descriptions dynamically
    const originalDescription = document.querySelector('textarea[name="description"]').value;
    const englishDescription = document.querySelector('textarea[name="description_eng"]').value;
    const spanishDescription = document.querySelector('textarea[name="description_esp"]').value;

    let missingDescriptions = [];

    // Validate status update
    if (['REVIEWED', 'IN_PRODUCTION'].includes(newStatus)) {
        if (isDescriptionEmpty(originalDescription)) {
            missingDescriptions.push('Original description');
        }
    }

    if (newStatus === 'IN_PRODUCTION') {
        if (isDescriptionEmpty(englishDescription)) {
            missingDescriptions.push('English description');
        }
        if (isDescriptionEmpty(spanishDescription)) {
            missingDescriptions.push('Spanish description');
        }
    }

    if (missingDescriptions.length > 0) {
        toastr.error(`Cannot move to ${newStatus}: ${missingDescriptions.join(', ')} is missing.`);
        // Revert the dropdown to previous status if applicable
        if (statusDropdown) {
            statusDropdown.value = '{{ business.status }}';
        }
        return; // Stop execution
    }

    // Properly encode data using URLSearchParams
    const params = new URLSearchParams();
    params.append('status', newStatus);

    // Proceed with status update
    fetch(`/change-business-status/${businessId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: `status=${encodeURIComponent(newStatus)}`,
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                // Update status display
                statusDisplay.textContent = `${data.new_status} `;
                const icon = document.createElement('i');
                icon.className = 'bx bx-caret-down';
                statusDisplay.appendChild(icon);

                toastr.success(`Status updated to ${data.new_status}`);
            } else {
                toastr.error(data.message || 'Error updating business status');
                // Revert the dropdown to previous status if applicable
                if (statusDropdown) {
                    statusDropdown.value = '{{ business.status }}';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            toastr.error(`An error occurred while updating the status: ${error.message}`);
            // Revert the dropdown to previous status if applicable
            if (statusDropdown) {
                statusDropdown.value = '{{ business.status }}';
            }
        });
}

});
</script>
<!-- End of JavaScript code for changing business status -->
<!--UPDATE BUSINESS STATUS-->
 
<!-- JavaScript for Handling Image Operations, edit -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const imageList = document.getElementById('image-list');

        // Initialize Sortable.js for sorting images
        const sortable = new Sortable(imageList, {
            animation: 150,
            onEnd: function () {
                // Get the new order of image IDs after sorting
                const sortedImageIds = Array.from(document.querySelectorAll('#image-list .draggable'))
                                            .map(el => el.getAttribute('data-id'));

                // Send AJAX request to update the order in the backend
                updateImageOrder(sortedImageIds);
            }
        });

        // Handle image approval using checkboxes
        document.querySelectorAll('.approve-checkbox').forEach(checkbox => {
            checkbox.addEventListener('click', function (e) {
                e.stopPropagation();  // Prevent interfering with drag functionality
                const imageId = this.dataset.id;
                const isApproved = this.checked;

                // Update the approval status via AJAX
                updateImageApproval(imageId, isApproved);
            });
        });

        // Handle image deletion using SweetAlert
        document.querySelectorAll('.delete-image-btn').forEach(button => {
            button.addEventListener('click', function (e) {
                const imageId = this.dataset.id;
                Swal.fire({
                    title: 'Are you sure?',
                    text: "Do you really want to delete this image?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Call the function to delete the image
                        deleteImage(imageId);
                    }
                });
            });
        });

        // Function to send AJAX request to update image approval status
        function updateImageApproval(imageId, isApproved) {
            const csrfToken = getCookie('csrftoken');

            fetch('/update-image-approval/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    image_id: imageId,
                    is_approved: isApproved
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    toastr.success('Image approval status updated.');
                } else {
                    toastr.error('Error updating image approval status: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                toastr.error('An error occurred while updating approval status.');
            });
        }

        // Function to delete an image via AJAX
        function deleteImage(imageId) {
            const csrfToken = getCookie('csrftoken');

            fetch(`/delete-image/${imageId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove the image from the DOM
                    const imageCard = document.querySelector(`.image-card[data-id="${imageId}"]`);
                    if (imageCard) {
                        imageCard.remove();
                    }
                    toastr.success('The image has been deleted.');
                } else {
                    toastr.error('Error deleting image: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                toastr.error('An error occurred while deleting the image.');
            });
        }

        // Function to send the new order to the backend
        function updateImageOrder(sortedImageIds) {
            const csrfToken = getCookie('csrftoken');
            const businessId = '{{ business.id }}';

            fetch(`/update-image-order/${businessId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    order: sortedImageIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    toastr.success('Image order updated successfully.');
                } else {
                    toastr.error('Error updating image order: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                toastr.error('An error occurred while updating the image order.');
            });
        }

        // Get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
<!-- JavaScript for Handling Image Operations, edit -->
 
<!--Edit-business-->          
<script>
    // Helper function for CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie) {
            const cookies = document.cookie.split(';');
            cookies.forEach(cookie => {
                const trimmed = cookie.trim();
                if (trimmed.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(trimmed.substring(name.length + 1));
                    return;
                }
            });
        }
        return cookieValue;
    }

    // Initialize the isOperatingHoursEditMode variable
    let isOperatingHoursEditMode = false;

    // Function to toggle edit mode for a field
    function toggleEdit(field) {
    const displayElement = document.getElementById(`${field}-display`);
    const editElement = $(`#${field}-edit`);

    if (displayElement && editElement.length) {
        const isVisible = editElement.is(':visible');
        if (isVisible) {
            // Hide the edit element
            if (editElement.hasClass('select2-hidden-accessible')) {
                // Destroy Select2 instance if initialized
                editElement.select2('destroy');
            }
            editElement.hide();
            displayElement.style.display = '';
        } else {
            // Show the edit element
            displayElement.style.display = 'none';
            editElement.show();
            // Initialize Select2 only if the element has class 'select2'
            if (editElement.hasClass('select2')) {
                editElement.select2({
                    placeholder: "Select options",
                    allowClear: true,
                    width: '100%'
                });
            }
        }
    }
}
 
    function editOperatingHours() {
        isOperatingHoursEditMode = !isOperatingHoursEditMode;
        localStorage.setItem('isOperatingHoursEditMode', isOperatingHoursEditMode);

        document.querySelectorAll('#business-form .box-list li').forEach(li => {
            const day = li.querySelector('input').name.replace('operating_hours[', '').replace(']', '');
            const displayElem = document.getElementById(`${day}_display`);
            const inputElem = document.getElementById(`${day}_edit`);

            if (isOperatingHoursEditMode) {
                displayElem.style.display = 'none';
                inputElem.style.display = 'block';
            } else {
                displayElem.textContent = inputElem.value;  
                displayElem.style.display = 'block';
                inputElem.style.display = 'none';
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Restore toggled edit states on page load
        const fields = ['title', 'website', 'status', 'city', 'price', 'phone', 'address', 'postal_code', 'level_title', 'description', 'description-eng', 'description-esp', 'categories', 'main_category', 'types', 'operating_hours', 'tailored_category'];
        fields.forEach(field => {
            if (localStorage.getItem(`${field}-edit`) === 'true') {
                toggleEdit(field);
            }
        });

        // Restore operating hours edit state
        isOperatingHoursEditMode = localStorage.getItem('isOperatingHoursEditMode') === 'true';

        document.querySelectorAll('#business-form .box-list li').forEach(li => {
            const day = li.querySelector('input').name.replace('operating_hours[', '').replace(']', '');
            const displayElem = document.getElementById(`${day}_display`);
            const inputElem = document.getElementById(`${day}_edit`);

            if (isOperatingHoursEditMode) {
                displayElem.style.display = 'none';
                inputElem.style.display = 'block';
            } else {
                displayElem.style.display = 'block';
                inputElem.style.display = 'none';
            }
        });

        // Add event listener for the form submission
        const businessForm = document.getElementById('business-form');
        businessForm.addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(this);

            // Collect operating hours
            const operatingHours = {};
            document.querySelectorAll('#business-form .box-list input').forEach(input => {
                const day = input.name.replace('operating_hours[', '').replace(']', '');
                operatingHours[day] = input.value;
            });

            // Add operating hours to formData as a JSON string
            formData.set('operating_hours', JSON.stringify(operatingHours));

            // Collect categories
            const categories = [];
            document.querySelectorAll('input[name="categories"]:checked').forEach(input => {
                categories.push(input.value);
            });
            formData.delete('categories'); // Remove existing categories entries
            categories.forEach(id => {
                formData.append('categories', id);
            });

            // Collect other fields as necessary

            fetch(this.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    toastr.success('Business information updated successfully!');
                    location.reload();
                } else {
                    toastr.error('There were errors: ' + JSON.stringify(data.errors));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                toastr.error('An error occurred while updating the business.');
            });
        });

        // Function to show the loading modal
        function showLoadingModal() {
            document.getElementById('loading-modal').style.display = 'block';
        }

        // Function to hide the loading modal
        function hideLoadingModal() {
            document.getElementById('loading-modal').style.display = 'none';
        }


     // Add event listener for the Generate Description button
     const generateDescriptionBtn = document.getElementById('generate-description-btn');
    if (generateDescriptionBtn) {
        generateDescriptionBtn.addEventListener('click', function() {
            // Show loading modal using SweetAlert2
            Swal.fire({
                title: 'Generating Description',
                text: 'Please wait while the description is being generated...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            // Collect business details
            const businessId = '{{ business.id }}';
            const businessTitle = '{{ business.title }}';
            const city = '{{ business.city }}';
            const country = '{{ business.form_country_name }}';
            const category = '{{ business.main_category }}';

            // Prepare data to send
            const data = {
                business_id: businessId,
                title: businessTitle,
                city: city,
                country: country,
                category: category,
            };

            // Send AJAX request to generate description
            fetch('{% url "generate_description" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(result => {
                Swal.close();

                if (result.success) {
                    const descriptionEdit = document.getElementById('description-edit');
                    descriptionEdit.value = result.description;
                    descriptionEdit.style.display = 'block';
                    const descriptionDisplay = document.getElementById('description-display');
                    descriptionDisplay.style.display = 'none';
                    generateDescriptionBtn.style.display = 'none';
                    toastr.success('Description generated successfully!');
                } else {
                    toastr.error('Error generating description: ' + result.error);
                }
            })
            .catch(error => {
                Swal.close();
                console.error('Error:', error);
                toastr.error('An error occurred while generating the description.');
            });
        });
    }
});
</script>
<!--Edit-business-->
 
<!--select2-->
<script>
$(document).ready(function() {
    // Initialize Select2 on elements with class 'select2'
    $('.select2').select2({
        placeholder: "Select options",
        allowClear: true,
        width: '100%'  // Ensures the dropdown fits the container
    });
});
</script>
<!--select2-->

    
<!-- ENHANCE AND TRANSLATE -->
<script>
    function enhanceAndTranslateDescription(businessId) {
        Swal.fire({
            title: 'Enhance and Translate Description',
            text: 'Are you sure you want to enhance and translate the description?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, proceed',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed) {
                // Show loading indicator
                Swal.fire({
                    title: 'Processing',
                    html: '<i class="fa-solid fa-language fa-2x"></i><br>Enhancing and translating the description. Please wait...',
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                fetch(`/enhance_translate_business/${businessId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ languages: ['spanish', 'eng'] })
                })
                .then(response => response.json())
                .then(data => {
                    Swal.close(); // Close the loading indicator

                    if (data.success) {
                        // Show success message
                        Swal.fire({
                            title: 'Success',
                            text: 'Description has been enhanced and translated successfully.',
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            // Update the descriptions on the page
                            document.getElementById('description-display').innerText = data.description;
                            // Update translated descriptions if they are displayed
                            if (document.getElementById('description-eng-display')) {
                                document.getElementById('description-eng-display').innerText = data.description_eng;
                            }
                            if (document.getElementById('description-esp-display')) {
                                document.getElementById('description-esp-display').innerText = data.description_esp;
                            }
                            location.reload();
                        });
                    } else {
                        // Show error message
                        Swal.fire({
                            title: 'Error',
                            text: 'Enhancement and translation could not be completed: ' + (data.message || 'Unknown error.'),
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.close(); // Close the loading indicator
                    Swal.fire({
                        title: 'Error',
                        text: 'An error occurred while enhancing and translating the description.',
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                });
            }
        });
    }
</script>
<!-- ENHANCE AND TRANSLATE -->

<!--Feedback-->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('Feedback script loaded');

        const feedbackButton = document.getElementById('feedback-button');
        if (!feedbackButton) {
            console.error('Feedback button not found');
            return;
        }

        feedbackButton.addEventListener('click', function (event) {
            event.preventDefault(); // Prevent form submission or default behavior
            event.stopPropagation(); // Stop propagation of the click event
            
            Swal.fire({
                title: `Feedback for {{ business.title }}`,
                html: `
                    <form id="feedback-form">
                        <div class="mb-3">
                            <label for="feedback-content" class="form-label">Comment</label>
                            <textarea id="feedback-content" class="form-control" rows="4" placeholder="Enter your feedback"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="feedback-status" class="form-label">Status</label>
                            <select id="feedback-status" class="form-control">
                                <option value="initial">Initial</option>
                                <option value="in_progress">In Progress</option>
                                <option value="done">Done</option>
                            </select>
                        </div>
                    </form>
                `,
                showCancelButton: true,
                confirmButtonText: 'Submit',
                preConfirm: () => {
                    const content = document.getElementById('feedback-content').value.trim();
                    const status = document.getElementById('feedback-status').value;
    
                    if (!content) {
                        Swal.showValidationMessage('Feedback comment is required');
                        return false;
                    }
    
                    return { content, status };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const feedbackData = result.value;

                    // Ensure `business.id` is available in this context
                    const businessId = '{{ business.id }}';

                    // Send feedback data to the server
                    fetch(`/feedback/${businessId}/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(feedbackData)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            Swal.fire('Success!', 'Your feedback has been submitted.', 'success');
                        } else {
                            Swal.fire('Error', data.message || 'An error occurred while submitting feedback.', 'error');
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', `An unexpected error occurred: ${error.message}`, 'error');
                    });
                }
            });
        });
    });
</script>

{% endblock %}

