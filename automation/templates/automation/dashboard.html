<!-- templates/automation/dashboard.html -->
{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="main-content project">   
    <div class="overlay" ></div>   
<!-- Dashboard Overview -->
<div class="container-fluid">
    <!-- Page Title -->
    <div class="row">
        <div class="col-12">
            <div class="page-title-wrapper">
                <h1 class="page-title">
                    <span class="title-icon">
                        <i class="fas fa-chart-line"></i>
                    </span>
                    <span class="title-text">Dashboard Overview</span>
                </h1>
            </div>
        </div>
    </div>
    {% if user.is_admin %}
<!-- Business Status Bar Chart -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    Business Status Distribution
                </h5>
                <div class="date-range d-flex gap-2">
                    <input type="date" id="startDate" class="form-control form-control-sm" placeholder="Start Date">
                    <input type="date" id="endDate" class="form-control form-control-sm" placeholder="End Date">
                    <button onclick="fetchAndUpdateData()" class="btn btn-sm btn-primary">
                        Update
                    </button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="businessStatusBarChart"></canvas>
            </div>
            <div class="card-footer bg-white">
                <div class="row text-center">
                    <div class="col">
                        <small class="text-muted">Pending</small>
                        <h6 id="pendingCount" class="mb-0 fw-bold text-warning">0</h6>
                    </div>
                    <div class="col">
                        <small class="text-muted">Reviewed</small>
                        <h6 id="reviewedCount" class="mb-0 fw-bold text-success">0</h6>
                    </div>
                    <div class="col">
                        <small class="text-muted">In Production</small>
                        <h6 id="productionCount" class="mb-0 fw-bold text-info">0</h6>
                    </div>
                    <div class="col">
                        <small class="text-muted">Discarded</small>
                        <h6 id="discardedCount" class="mb-0 fw-bold text-danger">0</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
    <!-- Recent Business Updates -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Uploaded Content & Businesses Gathered</h5>
                </div>
                <div class="card-body">
                    <canvas id="timelineChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- Date Filters and Totals -->
    <div class="row">
        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex ">
                        <div class="form-group">
                            <label for="start_date">Start Date:</label>
                            <input type="date" id="start_date" class="form-control" value="{{ default_start_date|date:'Y-m-d' }}">
                        </div>
                        <div class="form-group">
                            <label for="end_date">End Date:</label>
                            <input type="date" id="end_date" class="form-control" value="{{ default_end_date|date:'Y-m-d' }}">
                        </div>
                        <div class="form-group d-flex">
                        <button id="filterDates" class="btn btn-primary align-self-end">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <div class="row">
                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title text-primary">
                                <i class="fas fa-tasks"></i> Total Tasks Uploaded
                            </h6>
                            <h3 id="totalTasks" class="mb-0">{{ total_tasks }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title text-warning">
                                <i class="fas fa-building"></i> Total Businesses
                            </h6>
                            <h3 id="totalBusinesses" class="mb-0">{{ total_businesses }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Businesses by Category -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Businesses by Category</h5>
                    <select id="destinationSelector" class="form-select" style="width: 200px;">
                        <option value="">Select Destination</option>
                    </select>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task List -->
    <div class="row">
        <div class="col-12">
            <a href="{% url 'task_list' %}" class="btn btn-secondary mb-3">View all tasks</a>
        </div>
        {% for task in tasks|slice:":12" %}
        <div class="col-lg-3 col-md-6 col-sm-12">
            <div class="card">
                <div class="card-body">
                    <a title="{{ task.project_title }}" href="{% url 'task_detail' id=task.id %}" class="card-title d-block mb-2">
                        {{ task.id }} - {{ task.project_title|truncatechars:40 }}
                    </a>
                    <p># of Businesses: {{ task.businesses.count }}</p>
                    <p>User: {{ task.user }}</p>
                    <p>Created: {{ task.created_at }}</p>
                    <p>Completed: {{ task.completed_at }}</p>
                </div>
                <div class="card-footer">
                    <div class="d-flex align-items-center">
                        <div class="d-flex mb-3 mb-md-0">
                            <div class="task-btn status-{{ task.status|lower }} text-muted fs-14" data-bs-toggle="tooltip" data-bs-placement="top" title="Project Status">
                                {{ task.status }}
                            </div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="ms-auto mt-3 mt-sm-0">
                            {% if task.translation_status != 'TRANSLATED' %}
                            <button class="btn btn-outline-light text-muted pd-1 fs-14 start-translating-btn"
                                    data-task-id="{{ task.id }}">
                                <i class="fas fa-sync"></i> Start Translating 
                            </button>
                            {% else %}                                   
                            <button class="btn btn-outline-light text-muted pd-1 fs-14 disabled">
                                <i class="fas fa-check"></i> Translation Completed
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div> 
 
</div>
<!--Total Projects-->


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>

<!--Translate Tasks-->
<script>
document.addEventListener('DOMContentLoaded', function() {
const translatingButtons = document.querySelectorAll('.start-translating-btn');

translatingButtons.forEach(button => {
button.addEventListener('click', function(e) {
e.preventDefault();

if (this.classList.contains('disabled')) {
    Swal.fire({
        icon: 'info',
        title: 'Process in Progress',
        text: 'Please wait for the current operation to complete.'
    });
    return;
}

const taskId = this.getAttribute('data-task-id');
const originalText = this.innerHTML;
handleTranslation(this, taskId, originalText);
});
});

async function handleTranslation(button, taskId, originalText) {
try {
    // Show loading state
    Swal.fire({
        title: 'Translation in Progress',
        html: 'Please wait while we process your request...',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    // Disable button
    button.classList.add('disabled');
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Translating...';

    const response = await fetch(`/tasks/${taskId}/translate/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    });

    const data = await response.json();

    // Close loading dialog
    Swal.close();

    if (!response.ok) {
        throw new Error(data.message || 'Translation process failed');
    }

    handleTranslationResponse(data, button, originalText);

} catch (error) {
    console.error('Translation error:', error);
    Swal.fire({
        icon: 'error',
        title: 'Translation Failed',
        text: error.message || 'An unexpected error occurred'
    });
    resetButton(button, originalText);
}
}
function handleTranslationResponse(response) {
const data = response.details || {};

let message = `
    <div class="translation-status">
        <p>${response.message}</p>
        ${data.reason ? `<p class="reason">${data.reason}</p>` : ''}
        
        <div class="stats">
            <p>Total businesses: ${data.total || 0}</p>
            <p>Pending: ${data.pending || 0}</p>
            <p>Reviewed: ${data.reviewed || 0}</p>
            <p>Discarded: ${data.discarded || 0}</p>
        </div>

        ${data.error_details && data.error_details.length > 0 ? `
            <div class="errors">
                <h4>Issues Found:</h4>
                <ul>
                    ${data.error_details.map(error => 
                        `<li>Business ${error.business_id}: ${error.issue}</li>`
                    ).join('')}
                </ul>
            </div>
        ` : ''}
    </div>
`;

Swal.fire({
    icon: response.status === 'success' ? 'success' : 
        response.status === 'warning' ? 'warning' : 'error',
    title: response.status === 'success' ? 'Translation Complete' : 
        response.status === 'warning' ? 'Warning' : 'Translation Failed',
    html: message,
    confirmButtonText: 'OK'
});
}

function handleSuccess(data, button) {
button.innerHTML = '<i class="fas fa-check"></i> Translation Complete';

const taskId = button.getAttribute('data-task-id');
const taskUrl = `/tasks/${taskId}/details/`; // Adjust this URL according to your routing

Swal.fire({
    icon: 'success',
    title: 'Translation Successful',
    html: `
        <div class="translation-summary">
            ${createSuccessMessage(data)}
            <div class="mt-3">
                <a href="${taskUrl}" class="btn btn-info btn-sm">
                    <i class="fas fa-eye"></i> View Task Details
                </a>
            </div>
        </div>
    `,
    showCancelButton: true,
    confirmButtonText: 'Refresh Page',
    cancelButtonText: 'View Task',
    reverseButtons: true
}).then((result) => {
    if (result.isConfirmed) {
        location.reload();
    } else {
        window.location.href = taskUrl;
    }
});
}

function handleWarning(data, button, originalText) {
button.innerHTML = originalText;
button.classList.remove('disabled');

Swal.fire({
    icon: 'warning',
    title: 'Cannot Proceed',
    html: createWarningMessage(data),
    confirmButtonText: 'OK'
});
}

function handleError(data, button, originalText) {
button.innerHTML = originalText;
button.classList.remove('disabled');

Swal.fire({
    icon: 'error',
    title: 'Translation Error',
    html: createErrorMessage(data),
    confirmButtonText: 'OK',
    showCancelButton: true,
    cancelButtonText: 'Report Issue'
}).then((result) => {
    if (!result.isConfirmed) {
        reportIssue(data);
    }
});
}

function handleUnknownStatus(data, button, originalText) {
button.innerHTML = originalText;
button.classList.remove('disabled');

Swal.fire({
    icon: 'question',
    title: 'Unexpected Response',
    text: 'Received an unexpected response from the server.',
    confirmButtonText: 'OK'
});
}

function createSuccessMessage(data) {
return `
    <div class="translation-results">
        <p>${data.message || 'Translation completed successfully'}</p>
        ${data.details ? `
            <div class="translation-details">
                <p>Successfully processed: ${data.details.success || 0}</p>
                <p>Failed: ${data.details.failed || 0}</p>
                <p>Total: ${data.details.total || 0}</p>
                ${data.details.status_updates?.pending_to_reviewed > 0 ? 
                    `<p>Updated from pending: ${data.details.status_updates.pending_to_reviewed}</p>` : ''}
            </div>
        ` : ''}
    </div>
`;
}

function createWarningMessage(data) {
return `
    <div class="warning-message">
        <p>${data.message}</p>
        ${data.details ? `
            <div class="status-breakdown">
                <p>Current Status: ${data.details.current_status || 'Unknown'}</p>
                ${data.details.suggestion ? `<p>Suggestion: ${data.details.suggestion}</p>` : ''}
                <div class="business-stats">
                    <p>Total Businesses: ${data.details.total || 0}</p>
                    <p>Pending: ${data.details.pending || 0}</p>
                    <p>Reviewed: ${data.details.reviewed || 0}</p>
                </div>
            </div>
        ` : ''}
    </div>
`;
}

function createErrorMessage(data) {
return `
    <div class="error-message">
        <p>${data.message}</p>
        ${data.details ? `
            <div class="business-stats">
                ${data.details.total ? `<p>Total Businesses: ${data.details.total}</p>` : ''}
                ${data.details.pending ? `<p>Pending Review: ${data.details.pending}</p>` : ''}
                ${data.details.reviewed ? `<p>Reviewed: ${data.details.reviewed}</p>` : ''}
                ${data.details.discarded ? `<p>Discarded: ${data.details.discarded}</p>` : ''}
            </div>
        ` : ''}
        ${data.suggestion ? `
            <p class="suggestion">${data.suggestion}</p>
        ` : ''}
    </div>
`;
}

function getCookie(name) {
let cookieValue = null;
if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
        }
    }
}
return cookieValue;
}

function reportIssue(errorData) {
console.log('Reporting issue:', errorData);
// Implement your issue reporting logic here
Swal.fire({
    icon: 'info',
    title: 'Issue Reported',
    text: 'The issue has been logged for investigation.',
    confirmButtonText: 'OK'
});
}
});
</script>
<!--Translate Tasks-->

<script>
$(document).ready(function() {
    // Setup - add a text input to each footer cell
    $('#task-activity thead tr:eq(1) th').each(function (i) {
        var title = $(this).text();
        if (title !== 'Select' && title !== 'Action') {
            $('input', this).on('keyup change', function () {
                if (table.column(i).search() !== this.value) {
                    table
                        .column(i)
                        .search(this.value)
                        .draw();
                }
            });
        }
    });

    // Initialize DataTable
    var table = $('#task-activity').DataTable({
        "pageLength": 12,
        "lengthChange": true,
        "searching": true,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        orderCellsTop: true,
        fixedHeader: false
    });
});

</script>
             
<!-- Chart -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Debug: Check if data is available
    console.log('Timeline data:', {{ timeline_data|safe }});
    
    const timelineData = {{ timeline_data|safe }};
    const ctx = document.getElementById('timelineChart');
    
    if (!ctx) {
        console.error('Canvas element not found');
        return;
    }
    new Chart(ctx, {
        type: 'bar',   
        data: {
            labels: timelineData.dates,
            datasets: [
                {
                    label: 'Tasks Uploaded',
                    data: timelineData.tasks,
                    borderColor: '#212D94',
                    backgroundColor: 'rgba(33, 45, 148, 1)',
                    borderWidth: 2,
                    // For bar chart
                    barPercentage: 0.9,
                    categoryPercentage: 0.8,
                    // For line chart
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Businesses Gathered',
                    data: timelineData.businesses,
                    borderColor: '#F4C031',
                    backgroundColor: 'rgba(244, 192, 49, 0.7)',
                    borderWidth: 2,
                    // For bar chart
                    barPercentage: 0.9,
                    categoryPercentage: 0.8,
                    // For line chart
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    display: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Count'
                    },
                    ticks: {
                        precision: 0,
                        stepSize: 1
                    }
                }
            }
        }
    });
            

});
</script>
<!-- Chart -->
 
<!--Delete tasks-->
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const deleteButtons = document.querySelectorAll('.delete-task-btn');

    deleteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const taskId = this.getAttribute('data-task-id');
            const row = this.closest('tr');

            Swal.fire({
                title: 'Are you sure?',
                text: "Do you really want to delete this task?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/tasks/${taskId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Remove the row from the table
                            row.remove();
                            Swal.fire('Deleted!', 'The task has been deleted.', 'success');
                        } else {
                            Swal.fire('Error!', 'An error occurred while deleting the task.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error!', 'An error occurred while deleting the task.', 'error');
                    });
                }
            });
        });
    });
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    });
</script>
<!--Delete tasks-->

<!--CharT Destination by categories-->
<script>
    // Initialize destination categories chart
document.addEventListener('DOMContentLoaded', function() {
    let categoryChart = null;
    const destinations = {{ available_destinations|safe }};
    const destinationSelector = document.getElementById('destinationSelector');
    
    // Populate destination selector
    destinations.forEach(destination => {
        if (destination) {  // Only add non-null destinations
            const option = new Option(destination, destination);
            destinationSelector.add(option);
        }
    });

    // Function to create or update chart
    function updateCategoryChart(data) {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (categoryChart) {
            categoryChart.destroy();
        }
        
        // Create new chart
        categoryChart = new Chart(ctx, {
            type: 'bar',  // You can change to 'doughnut' for a different view
            data: {
                labels: data.categories,
                datasets: [{
                    label: 'Number of Businesses',
                    data: data.counts,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(153, 102, 255, 0.5)',
                        'rgba(255, 159, 64, 0.5)',
                        'rgba(199, 199, 199, 0.5)',
                        'rgba(83, 102, 255, 0.5)',
                        'rgba(40, 159, 64, 0.5)',
                        'rgba(210, 199, 199, 0.5)',
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(199, 199, 199, 1)',
                        'rgba(83, 102, 255, 1)',
                        'rgba(40, 159, 64, 1)',
                        'rgba(210, 199, 199, 1)',
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false  // Hide legend for bar chart
                    },
                    title: {
                        display: true,
                        text: data.destination ? 
                            `Business Categories in ${data.destination}` : 
                            'Business Categories (All Destinations)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }

    // Initial chart with all destinations
    updateCategoryChart({{ destination_categories|safe }});

    // Update chart when destination changes
    destinationSelector.addEventListener('change', function() {
        const selectedDestination = this.value;
        
        // Show loading state
        const chartContainer = document.querySelector('.chart-container');
        chartContainer.style.opacity = '0.5';
        
        // Fetch new data
        fetch(`/api/destination-categories/?destination=${encodeURIComponent(selectedDestination)}`)
            .then(response => response.json())
            .then(data => {
                updateCategoryChart(data);
                chartContainer.style.opacity = '1';
            })
            .catch(error => {
                console.error('Error fetching category data:', error);
                chartContainer.style.opacity = '1';
            });
    });
});

</script>
<!--CharT Destination by categories-->
 
<!--Businesses STATUS--> 
<script>
document.addEventListener('DOMContentLoaded', () => {
    let businessStatusChart = null;
    const DEBUG = true;
    function debugLog(message, data = null) {
        if (DEBUG) {
            console.log(`DEBUG: ${message}`, data || '');
        }
    }

    function initializeChart() {
        const ctx = document.getElementById('businessStatusBarChart');
        if (!ctx) {
            debugLog('Canvas element not found!');
            return null;
        }

        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Pending', 'Reviewed', 'In Production', 'Discarded'],
                datasets: [{
                    label: 'Number of Businesses',
                    data: [0, 0, 0, 0],
                    backgroundColor: [
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(0, 123, 255, 0.8)',
                        'rgba(220, 53, 69, 0.8)'
                    ],
                    borderColor: [
                        'rgb(255, 193, 7)',
                        'rgb(40, 167, 69)',
                        'rgb(0, 123, 255)',
                        'rgb(220, 53, 69)'
                    ],
                    borderWidth: 1,
                    borderRadius: 5,
                    maxBarThickness: 50
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: context => {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.raw;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `Count: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: true }
                }
            }
        });
    }

 
    function updateChart(chart, data) {
        debugLog('Chart data before update:', chart.data.datasets[0].data);
        debugLog('New data:', data);

        chart.data.datasets[0].data = [
            data.pending || 0,
            data.reviewed || 0,
            data.in_production || 0,
            data.discarded || 0,
        ];
        chart.update();
        debugLog('Chart data after update:', chart.data.datasets[0].data);
    }

    function updateStatusCounts(data) {
        debugLog('Updating status counts:', data);

        document.getElementById('pendingCount').textContent = data.pending || 0;
        document.getElementById('reviewedCount').textContent = data.reviewed || 0;
        document.getElementById('productionCount').textContent = data.in_production || 0;
        document.getElementById('discardedCount').textContent = data.discarded || 0;
    }

    async function fetchAndUpdateData() {
    const startDate = document.getElementById('startDate').value || '';
    const endDate = document.getElementById('endDate').value || '';

    debugLog('Fetching data with dates:', { startDate, endDate });

    if (!startDate || !endDate) {
        Swal.fire({
            icon: 'info',
            title: 'Info',
            text: 'Please select both start and end dates.'
        });
        return;
    }

    try {
        const response = await fetch(`/get-business-status-data/?start_date=${startDate}&end_date=${endDate}`);
        debugLog('Fetch response:', response);

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        debugLog('Fetched data:', data);

        if (data.error) {
            throw new Error(data.error);
        }

        // Update chart and counts
        if (data.datasets && data.datasets[0] && Array.isArray(data.datasets[0].data)) {
            updateChart(businessStatusChart, {
                pending: data.datasets[0].data[1],
                reviewed: data.datasets[0].data[3],
                in_production: data.datasets[0].data[2],
                discarded: data.datasets[0].data[0]
            });
            updateStatusCounts({
                pending: data.datasets[0].data[1],
                reviewed: data.datasets[0].data[3],
                in_production: data.datasets[0].data[2],
                discarded: data.datasets[0].data[0]
            });
        } else {
            debugLog('Invalid data structure received from API:', data);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Received invalid data format from server.'
            });
        }
    } catch (error) {
        console.error('Error fetching business status data:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to fetch business status data. Please try again.'
        });
    }
}


    function initializePage() {
        businessStatusChart = initializeChart();

        const initialData = {
            pending: {{ pending_count_business|default:0 }},
            reviewed: {{ reviewed_count_business|default:0 }},
            in_production: {{ production_count_business|default:0 }},
            discarded: {{ discarded_count_business|default:0 }}
        };

        debugLog('Initializing with data:', initialData);
        updateChart(businessStatusChart, initialData);
        updateStatusCounts(initialData);

        document.getElementById('startDate').addEventListener('change', fetchAndUpdateData);
        document.getElementById('endDate').addEventListener('change', fetchAndUpdateData);
    }

    initializePage();
});
</script>

<!-- Timeline Chart Script -->
<script>
let timelineChart = null;

function initializeChart(data) {
    const ctx = document.getElementById('timelineChart');
    
    if (timelineChart) {
        timelineChart.destroy();
    }

    timelineChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.dates,
            datasets: [
                {
                    label: 'Tasks Uploaded',
                    data: data.tasks,
                    borderColor: '#212D94',
                    backgroundColor: 'rgba(33, 45, 148, 1)',
                    borderWidth: 2,
                    barPercentage: 0.9,
                    categoryPercentage: 0.8,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Businesses Gathered',
                    data: data.businesses,
                    borderColor: '#F4C031',
                    backgroundColor: 'rgba(244, 192, 49, 0.7)',
                    borderWidth: 2,
                    barPercentage: 0.9,
                    categoryPercentage: 0.8,
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += context.parsed.y;
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    display: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Count'
                    },
                    ticks: {
                        precision: 0,
                        stepSize: 1
                    }
                }
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize with default data
    initializeChart({{ timeline_data|safe }});
    
    // Date filter functionality
    document.getElementById('filterDates').addEventListener('click', function() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        fetch(`/get-timeline-data/?start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                initializeChart(data);
                // Update totals
                document.getElementById('totalTasks').textContent = data.total_tasks;
                document.getElementById('totalBusinesses').textContent = data.total_businesses;
            })
            .catch(error => {
                console.error('Error fetching timeline data:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to fetch timeline data',
                    icon: 'error'
                });
            });
    });
});
</script>
    
{% endblock %}
