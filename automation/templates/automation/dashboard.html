<!-- templates/automation/dashboard.html -->
{% extends "base.html" %}
{% load static %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<style>
 .modern-card {background: white;border-radius: 0.5rem;border: 1px solid rgba(0, 0, 0, 0.1);transition: all 0.2s ease;height: 100%;}.modern-card:hover {transform: translateY(-2px);box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);}.card-content {padding: 0.75rem;}.card-header-flex {display: flex;justify-content: space-between;align-items: center;margin-bottom: 0.5rem;}.task-id {font-size: 0.75rem;color: #6b7280;}.status-badge {font-size: 0.65rem;padding: 0.25rem 0.5rem;border-radius: 9999px;font-weight: 500;}.status-live {background-color: #ecfdf5;color: #059669;border: 1px solid #34d399;}.status-review {background-color: #fffbeb;color: #d97706;border: 1px solid #fbbf24;}.status-active {background-color: #eff6ff;color: #2563eb;border: 1px solid #60a5fa;}.status-pending {background-color: #f3f4f6;color: #4b5563;border: 1px solid #9ca3af;}.status-failed {background-color: #fef2f2;color: #dc2626;border: 1px solid #f87171;}.task-title {display: block;font-size: 0.875rem;font-weight: 500;color: #111827;text-decoration: none;margin-bottom: 0.75rem;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;line-height: 1.25;}.task-title:hover {color: #2563eb;}.info-grid {display: grid;gap: 0.25rem;font-size: 0.75rem;}.info-row {display: grid;grid-template-columns: 1fr 1fr;gap: 0.5rem;}.info-label {color: #6b7280;}.info-value {text-align: right;color: #111827;font-weight: 500;}@media (prefers-color-scheme: dark) {.modern-card {background: #1f2937;border-color: rgba(255, 255, 255, 0.1);}.task-id {color: #9ca3af;}.task-title {color: #f3f4f6;}.task-title:hover {color: #60a5fa;}.info-label {color: #9ca3af;}.info-value {color: #f3f4f6;}}.chart-summary-container{margin-top:2rem;padding:1.5rem;background:#fff;border-radius:8px;box-shadow:0 2px 4px rgb(0 0 0 / .08)}.summary-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid rgb(0 0 0 / .1)}.summary-title{font-size:1.1rem;font-weight:600;color:#333;margin:0}.total-count{display:flex;flex-direction:column;align-items:flex-end}.total-label{font-size:.875rem;color:#666;margin-bottom:.25rem}.total-number{font-size:1.25rem;font-weight:600;color:#333}.status-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem}.status-card{padding:1rem;background:rgb(0 0 0 / .02);border-radius:6px;transition:transform 0.2s ease,box-shadow 0.2s ease}.status-card:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgb(0 0 0 / .05)}.status-info{display:flex;align-items:center;margin-bottom:.75rem}.status-dot{width:10px;height:10px;border-radius:50%;margin-right:8px}.status-label{font-size:.9rem;color:#555}.status-numbers{display:flex;justify-content:space-between;align-items:baseline}.status-count{font-size:1.25rem;font-weight:600;color:#333}.status-percentage{font-size:.875rem;color:#666}@media (max-width:768px){.status-grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}.summary-header{flex-direction:column;align-items:flex-start}.total-count{margin-top:1rem;align-items:flex-start}}
</style>
<div class="main-content project">   
    <div class="overlay" ></div>   
<!-- Dashboard Overview -->
<div class="container-fluid">
    <!-- Page Title -->
    <div class="row">
        <div class="col-12">
            <div class="page-title-wrapper">
                <h1 class="page-title">
                    <span class="title-icon">
                        <i class="fas fa-chart-line"></i>
                    </span>
                    <span class="title-text">Dashboard Overview</span>
                </h1>
            </div>
        </div>
    </div>
    {% if user.is_admin %}
<!-- Business Status Bar Chart -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="row">
                    <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12">
                        <h5 class="card-title mb-0">
                            Business Status Distribution
                        </h5>
                    </div>
                    <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12">
                        
                <div class="date-range d-flex gap-2">
                    <input type="date" id="startDate" class="form-control form-control-sm" placeholder="Start Date">
                    <input type="date" id="endDate" class="form-control form-control-sm" placeholder="End Date">
                    <button onclick="fetchAndUpdateData()" class="btn btn-sm btn-primary">
                        Update
                    </button>
                </div>
                    </div>
                </div>
                
            </div>
            <div class="card-body">
                <canvas id="businessStatusBarChart"></canvas>
            </div>
            <div class="card-footer bg-white">
                <div class="row text-center">
                    <div class="col">
                        <small class="text-muted">Pending</small>
                        <h6 id="pendingCount" class="mb-0 fw-bold text-warning">0</h6>
                    </div>
                    <div class="col">
                        <small class="text-muted">Reviewed</small>
                        <h6 id="reviewedCount" class="mb-0 fw-bold text-success">0</h6>
                    </div>
                    <div class="col">
                        <small class="text-muted">In Production</small>
                        <h6 id="productionCount" class="mb-0 fw-bold text-info">0</h6>
                    </div>
                    <div class="col">
                        <small class="text-muted">Discarded</small>
                        <h6 id="discardedCount" class="mb-0 fw-bold text-danger">0</h6>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
    <!-- Recent Business Updates -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Uploaded Content & Businesses Gathered</h5>
                </div>
                <div class="card-body">
                    <canvas id="timelineChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
    <!-- Date Filters and Totals -->
    <div class="row">
        <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12">
            <div class="card">
                <div class="card-body">                    
                        <div class="row">
                            <div class="col-xl-5 col-lg-5 col-md-12 col-sm-12">
                                <div class="form-group">
                                    <label for="start_date">Start Date:</label>
                                    <input type="date" id="start_date" class="form-control" value="{{ default_start_date|date:'Y-m-d' }}">
                                </div>
                            </div>
                            <div class="col-xl-5 col-lg-5 col-md-12 col-sm-12">
                                <div class="form-group">
                                    <label for="end_date">End Date:</label>
                                    <input type="date" id="end_date" class="form-control" value="{{ default_end_date|date:'Y-m-d' }}">
                                </div>
                            </div>
                            <div class="col-xl-2 col-lg-2 col-md-12 col-sm-12 mt-2">
                                <div class="form-group d-flex">
                                    <button id="filterDates" class="btn btn-primary btn-lg align-self-end mt-18">
                                        <i class="fas fa-filter"></i> Filter
                                    </button>
                                    </div>
                            </div>
                        </div> 
                         
                </div>
            </div>
        </div>
        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
            <div class="row">
                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title text-primary">
                                <i class="fas fa-tasks"></i> Total Tasks Uploaded
                            </h6>
                            <h3 id="totalTasks" class="mb-0">{{ total_tasks }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6 class="card-title text-warning">
                                <i class="fas fa-building"></i> Total Businesses
                            </h6>
                            <h3 id="totalBusinesses" class="mb-0">{{ total_businesses }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Businesses by Category -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header justify-content-between align-items-center">
                    <div class="row">
                        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
                            <h5 class="card-title mb-0">Businesses by Category</h5>
                        </div>
                        <div class="col-xl-6 col-lg-12 col-md-12 col-sm-12">
                            <select id="destinationSelector" class="form-select">
                                <option value="">Select Destination</option>
                            </select>
                        </div>
                    </div>    
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:400px; width:100%">
                        <canvas id="categoryChart"></canvas>
                    </div>
                    <div id="chartSummary" class="mt-4"></div>
                </div>
            </div>
        </div>
    </div>

<!-- Task List -->
<div class="row g-3 mt-18">
    <div class="col-12 mb-2">
        <a href="{% url 'task_list' %}" class="btn btn-secondary btn-sm">View all tasks</a> <br />
    </div>

    {% for task in tasks|slice:":12" %}
    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
        <div class="modern-card">
            <div class="card-content">
                <!-- Header: ID and Status -->
                <div class="card-header-flex">
                    <span class="task-id">#{{ task.id }}</span>
                    {% if task.status == 'DONE' %}
                        <span class="status-badge status-live">LIVE</span>
                    {% elif task.status == 'COMPLETED' %}
                        <span class="status-badge status-review">REVIEW</span>
                    {% elif task.status == 'IN_PROGRESS' %}
                        <span class="status-badge status-active">ACTIVE</span>
                    {% elif task.status == 'FAILED' %}
                        <span class="status-badge status-failed">FAILED</span>
                    {% else %}
                        <span class="status-badge status-pending">PENDING</span>
                    {% endif %}
                </div>

                <!-- Title -->
                <a href="{% url 'task_detail' id=task.id %}" 
                   class="task-title" 
                   title="{{ task.project_title }}">
                    {{ task.project_title }}
                </a>

                <!-- Info Grid -->
                <div class="info-grid">
                    <div class="info-row">
                        <span class="info-label">Businesses:</span>
                        <span class="info-value">{{ task.businesses.count }}</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Created:</span>
                        <span class="info-value">{{ task.created_at }}</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">Completed:</span>
                        <span class="info-value">{{ task.completed_at }}</span>
                    </div>
                    
                    <div class="info-row">
                        <span class="info-label">User:</span>
                        <span class="info-value text-truncate" title="{{ task.user }}">{{ task.user }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
</div> 
</div>
<!--Total Projects-->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment"></script>
<!-- In the head section -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<!-- Before closing body -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
 
 
<script>
$(document).ready(function() {
    // Setup - add a text input to each footer cell
    $('#task-activity thead tr:eq(1) th').each(function (i) {
        var title = $(this).text();
        if (title !== 'Select' && title !== 'Action') {
            $('input', this).on('keyup change', function () {
                if (table.column(i).search() !== this.value) {
                    table
                        .column(i)
                        .search(this.value)
                        .draw();
                }
            });
        }
    });

    // Initialize DataTable
    var table = $('#task-activity').DataTable({
        "pageLength": 12,
        "lengthChange": true,
        "searching": true,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        orderCellsTop: true,
        fixedHeader: false
    });
});

</script>
             
<!-- Chart -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Debug: Check if data is available
    console.log('Timeline data:', {{ timeline_data|safe }});
    
    const timelineData = {{ timeline_data|safe }};
    const ctx = document.getElementById('timelineChart');
    
    if (!ctx) {
        console.error('Canvas element not found');
        return;
    }
    new Chart(ctx, {
        type: 'bar',   
        data: {
            labels: timelineData.dates,
            datasets: [
                {
                    label: 'Tasks Uploaded',
                    data: timelineData.tasks,
                    borderColor: '#212D94',
                    backgroundColor: 'rgba(33, 45, 148, 1)',
                    borderWidth: 2,
                    // For bar chart
                    barPercentage: 0.9,
                    categoryPercentage: 0.8,
                    // For line chart
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Businesses Gathered',
                    data: timelineData.businesses,
                    borderColor: '#F4C031',
                    backgroundColor: 'rgba(244, 192, 49, 0.7)',
                    borderWidth: 2,
                    // For bar chart
                    barPercentage: 0.9,
                    categoryPercentage: 0.8,
                    // For line chart
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    display: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Count'
                    },
                    ticks: {
                        precision: 0,
                        stepSize: 1
                    }
                }
            }
        }
    });
            

});
</script>
<!-- Chart -->
 
<!--Delete tasks-->
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const deleteButtons = document.querySelectorAll('.delete-task-btn');

    deleteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const taskId = this.getAttribute('data-task-id');
            const row = this.closest('tr');

            Swal.fire({
                title: 'Are you sure?',
                text: "Do you really want to delete this task?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/tasks/${taskId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Remove the row from the table
                            row.remove();
                            Swal.fire('Deleted!', 'The task has been deleted.', 'success');
                        } else {
                            Swal.fire('Error!', 'An error occurred while deleting the task.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error!', 'An error occurred while deleting the task.', 'error');
                    });
                }
            });
        });
    });
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    });
</script>
<!--Delete tasks-->

<!--CharT Destination by categories-->
<script> 
document.addEventListener('DOMContentLoaded', function() {
    let categoryChart = null;
    const destinations = {{ available_destinations|safe }};
    const destinationSelector = document.getElementById('destinationSelector');

    destinations.forEach(destination => {
        if (destination && destination.id) {  // Make sure we have valid destination data
            const option = document.createElement('option');
            option.value = destination.id;     // Use the ID as the value
            option.textContent = destination.name;  // Use the name as display text
            destinationSelector.appendChild(option);
        }
    });

    function updateCategoryChart(data) {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        
        if (categoryChart) {
            categoryChart.destroy();
        }

        categoryChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Object.keys(data.categories.main || {}),
                datasets: [{
                    label: 'Number of Businesses',
                    data: Object.values(data.categories.main || {}),
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.5)',
                        'rgba(54, 162, 235, 0.5)',
                        'rgba(255, 206, 86, 0.5)',
                        'rgba(75, 192, 192, 0.5)',
                        'rgba(153, 102, 255, 0.5)',
                        'rgba(255, 159, 64, 0.5)',
                        'rgba(199, 199, 199, 0.5)',
                        'rgba(83, 102, 255, 0.5)',
                        'rgba(40, 159, 64, 0.5)',
                        'rgba(210, 199, 199, 0.5)',
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(199, 199, 199, 1)',
                        'rgba(83, 102, 255, 1)',
                        'rgba(40, 159, 64, 1)',
                        'rgba(210, 199, 199, 1)',
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    title: {
                        display: true,
                        text: data.destination_name ? 
                            `Business Categories in ${data.destination_name}` : 
                            'Business Categories (All Destinations)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });

        // Update summary information
        updateSummaryInfo(data);
    }

    function updateSummaryInfo(data) {
    const summaryDiv = document.getElementById('chartSummary');
    if (summaryDiv && data.status_details) {
        // Calculate percentages
        const total = data.total_businesses || 0;
        const getPercentage = (value) => total ? Math.round((value / total) * 100) : 0;

        summaryDiv.innerHTML = `
            <div class="chart-summary-container">
                <div class="summary-header">
                    <h6 class="summary-title">Status Distribution</h6>
                    <div class="total-count">
                        <span class="total-label">Total Businesses</span>
                        <span class="total-number">${total}</span>
                    </div>
                </div>
                
                <div class="status-grid">
                    <div class="status-card">
                        <div class="status-info">
                            <div class="status-dot" style="background: rgba(220, 53, 69, 0.8)"></div>
                            <span class="status-label">Discarded</span>
                        </div>
                        <div class="status-numbers">
                            <span class="status-count">${data.status_details.DISCARDED || 0}</span>
                            <span class="status-percentage">${getPercentage(data.status_details.DISCARDED)}%</span>
                        </div>
                    </div>

                    <div class="status-card">
                        <div class="status-info">
                            <div class="status-dot" style="background: rgba(255, 193, 7, 0.8)"></div>
                            <span class="status-label">Pending</span>
                        </div>
                        <div class="status-numbers">
                            <span class="status-count">${data.status_details.PENDING || 0}</span>
                            <span class="status-percentage">${getPercentage(data.status_details.PENDING)}%</span>
                        </div>
                    </div>

                    <div class="status-card">
                        <div class="status-info">
                            <div class="status-dot" style="background: rgba(40, 167, 69, 0.8)"></div>
                            <span class="status-label">Reviewed</span>
                        </div>
                        <div class="status-numbers">
                            <span class="status-count">${data.status_details.REVIEWED || 0}</span>
                            <span class="status-percentage">${getPercentage(data.status_details.REVIEWED)}%</span>
                        </div>
                    </div>

                    <div class="status-card">
                        <div class="status-info">
                            <div class="status-dot" style="background: rgba(23, 162, 184, 0.8)"></div>
                            <span class="status-label">In Production</span>
                        </div>
                        <div class="status-numbers">
                            <span class="status-count">${data.status_details.IN_PRODUCTION || 0}</span>
                            <span class="status-percentage">${getPercentage(data.status_details.IN_PRODUCTION)}%</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}
 
    updateCategoryChart({{ destination_categories|safe }});
 
    destinationSelector.addEventListener('change', function() {
        const selectedDestinationId = this.value;   
        if (!selectedDestinationId) return;  
        const chartContainer = document.querySelector('.chart-container');
        chartContainer.style.opacity = '0.5';

        fetch(`/api/destination-categories/?destination=${selectedDestinationId}`)  // Using the ID directly
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    updateCategoryChart(data);
                } else {
                    console.error('Error:', data.message);
                }
                chartContainer.style.opacity = '1';
            })
            .catch(error => {
                console.error('Error fetching category data:', error);
                chartContainer.style.opacity = '1';
            });
    });
});

</script> 
<!--CharT Destination by categories-->
 
<!--Businesses STATUS--> 
<script>
document.addEventListener('DOMContentLoaded', () => {
    let businessStatusChart = null;
    const DEBUG = true;
    function debugLog(message, data = null) {
        if (DEBUG) {
            console.log(`DEBUG: ${message}`, data || '');
        }
    }

    function initializeChart() {
        const ctx = document.getElementById('businessStatusBarChart');
        if (!ctx) {
            debugLog('Canvas element not found!');
            return null;
        }

        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Pending', 'Reviewed', 'In Production', 'Discarded'],
                datasets: [{
                    label: 'Number of Businesses',
                    data: [0, 0, 0, 0],
                    backgroundColor: [
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(0, 123, 255, 0.8)',
                        'rgba(220, 53, 69, 0.8)'
                    ],
                    borderColor: [
                        'rgb(255, 193, 7)',
                        'rgb(40, 167, 69)',
                        'rgb(0, 123, 255)',
                        'rgb(220, 53, 69)'
                    ],
                    borderWidth: 1,
                    borderRadius: 5,
                    maxBarThickness: 50
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: context => {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const value = context.raw;
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `Count: ${value} (${percentage}%)`;
                            }
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { beginAtZero: true }
                }
            }
        });
    }

 
    function updateChart(chart, data) {
        debugLog('Chart data before update:', chart.data.datasets[0].data);
        debugLog('New data:', data);

        chart.data.datasets[0].data = [
            data.pending || 0,
            data.reviewed || 0,
            data.in_production || 0,
            data.discarded || 0,
        ];
        chart.update();
        debugLog('Chart data after update:', chart.data.datasets[0].data);
    }

    function updateStatusCounts(data) {
        debugLog('Updating status counts:', data);

        document.getElementById('pendingCount').textContent = data.pending || 0;
        document.getElementById('reviewedCount').textContent = data.reviewed || 0;
        document.getElementById('productionCount').textContent = data.in_production || 0;
        document.getElementById('discardedCount').textContent = data.discarded || 0;
    }

    async function fetchAndUpdateData() {
    const startDate = document.getElementById('startDate').value || '';
    const endDate = document.getElementById('endDate').value || '';

    debugLog('Fetching data with dates:', { startDate, endDate });

    if (!startDate || !endDate) {
        Swal.fire({
            icon: 'info',
            title: 'Info',
            text: 'Please select both start and end dates.'
        });
        return;
    }

    try {
        const response = await fetch(`/get-business-status-data/?start_date=${startDate}&end_date=${endDate}`);
        debugLog('Fetch response:', response);

        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }

        const data = await response.json();
        debugLog('Fetched data:', data);

        if (data.error) {
            throw new Error(data.error);
        }

        // Update chart and counts
        if (data.datasets && data.datasets[0] && Array.isArray(data.datasets[0].data)) {
            updateChart(businessStatusChart, {
                pending: data.datasets[0].data[1],
                reviewed: data.datasets[0].data[3],
                in_production: data.datasets[0].data[2],
                discarded: data.datasets[0].data[0]
            });
            updateStatusCounts({
                pending: data.datasets[0].data[1],
                reviewed: data.datasets[0].data[3],
                in_production: data.datasets[0].data[2],
                discarded: data.datasets[0].data[0]
            });
        } else {
            debugLog('Invalid data structure received from API:', data);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Received invalid data format from server.'
            });
        }
    } catch (error) {
        console.error('Error fetching business status data:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to fetch business status data. Please try again.'
        });
    }
}


    function initializePage() {
        businessStatusChart = initializeChart();

        const initialData = {
            pending: {{ pending_count_business|default:0 }},
            reviewed: {{ reviewed_count_business|default:0 }},
            in_production: {{ production_count_business|default:0 }},
            discarded: {{ discarded_count_business|default:0 }}
        };

        debugLog('Initializing with data:', initialData);
        updateChart(businessStatusChart, initialData);
        updateStatusCounts(initialData);

        document.getElementById('startDate').addEventListener('change', fetchAndUpdateData);
        document.getElementById('endDate').addEventListener('change', fetchAndUpdateData);
    }

    initializePage();
});
</script>

<!-- Timeline Chart Script -->
<script>
let timelineChart = null;

function initializeChart(data) {
    const ctx = document.getElementById('timelineChart');
    
    if (timelineChart) {
        timelineChart.destroy();
    }

    timelineChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.dates,
            datasets: [
                {
                    label: 'Tasks Uploaded',
                    data: data.tasks,
                    borderColor: '#212D94',
                    backgroundColor: 'rgba(33, 45, 148, 1)',
                    borderWidth: 2,
                    barPercentage: 0.9,
                    categoryPercentage: 0.8,
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Businesses Gathered',
                    data: data.businesses,
                    borderColor: '#F4C031',
                    backgroundColor: 'rgba(244, 192, 49, 0.7)',
                    borderWidth: 2,
                    barPercentage: 0.9,
                    categoryPercentage: 0.8,
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += context.parsed.y;
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    display: true,
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Count'
                    },
                    ticks: {
                        precision: 0,
                        stepSize: 1
                    }
                }
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize with default data
    initializeChart({{ timeline_data|safe }});
    
    // Date filter functionality
    document.getElementById('filterDates').addEventListener('click', function() {
        const startDate = document.getElementById('start_date').value;
        const endDate = document.getElementById('end_date').value;
        
        fetch(`/get-timeline-data/?start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                initializeChart(data);
                // Update totals
                document.getElementById('totalTasks').textContent = data.total_tasks;
                document.getElementById('totalBusinesses').textContent = data.total_businesses;
            })
            .catch(error => {
                console.error('Error fetching timeline data:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Failed to fetch timeline data',
                    icon: 'error'
                });
            });
    });
});
</script>
 
{% endblock %}
