<!-- templates/automation/dashboard.html -->
{% extends "base.html" %}
{% load static %}
{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
 
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>.task-item {transition: transform 0.2s;}.task-item:hover {transform: translateY(-2px);box-shadow: 0 4px 8px rgba(0,0,0,0.1);}.badge {font-size: 0.75rem;padding: 0.25em 0.6em;}.card-header {background-color: #f8f9fc;border-bottom: 1px solid #e3e6f0;}.task-link {text-decoration: none; color: inherit;}.task-link:hover {text-decoration: none; color: #4e73df;}.modern-card {background: white;border-radius: 0.5rem;border: 1px solid rgba(0, 0, 0, 0.1);transition: all 0.2s ease;height: 100%;}.modern-card:hover {transform: translateY(-2px);box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);}.card-content {padding: 0.75rem;}.card-header-flex {display: flex;justify-content: space-between;align-items: center;margin-bottom: 0.5rem;}.task-id {font-size: 0.75rem;color: #6b7280;}.status-badge {font-size: 0.65rem;padding: 0.25rem 0.5rem;border-radius: 9999px;font-weight: 500;}.status-live {background-color: #ecfdf5;color: #059669;border: 1px solid #34d399;}.status-review {background-color: #fffbeb;color: #d97706;border: 1px solid #fbbf24;}.status-active {background-color: #eff6ff;color: #2563eb;border: 1px solid #60a5fa;}.status-pending {background-color: #f3f4f6;color: #4b5563;border: 1px solid #9ca3af;}.status-failed {background-color: #fef2f2;color: #dc2626;border: 1px solid #f87171;}.task-title {display: block;font-size: 0.875rem;font-weight: 500;color: #111827;text-decoration: none;margin-bottom: 0.75rem;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;line-height: 1.25;}.task-title:hover {color: #2563eb;}.info-grid {display: grid;gap: 0.25rem;font-size: 0.75rem;}.info-row {display: grid;grid-template-columns: 1fr 1fr;gap: 0.5rem;}.info-label {color: #6b7280;}.info-value {text-align: right;color: #111827;font-weight: 500;}@media (prefers-color-scheme: dark) {.modern-card {background: #1f2937;border-color: rgba(255, 255, 255, 0.1);}.task-id {color: #9ca3af;}.task-title {color: #f3f4f6;}.task-title:hover {color: #60a5fa;}.info-label {color: #9ca3af;}.info-value {color: #f3f4f6;}}.chart-summary-container{margin-top:2rem;padding:1.5rem;background:#fff;border-radius:8px;box-shadow:0 2px 4px rgb(0 0 0 / .08)}.summary-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid rgb(0 0 0 / .1)}.summary-title{font-size:1.1rem;font-weight:600;color:#333;margin:0}.total-count{display:flex;flex-direction:column;align-items:flex-end}.total-label{font-size:.875rem;color:#666;margin-bottom:.25rem}.total-number{font-size:1.25rem;font-weight:600;color:#333}.status-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem}.status-card{padding:1rem;background:rgb(0 0 0 / .02);border-radius:6px;transition:transform 0.2s ease,box-shadow 0.2s ease}.status-card:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgb(0 0 0 / .05)}.status-info{display:flex;align-items:center;margin-bottom:.75rem}.status-dot{width:10px;height:10px;border-radius:50%;margin-right:8px}.status-label{font-size:.9rem;color:#555}.status-numbers{display:flex;justify-content:space-between;align-items:baseline}.status-count{font-size:1.25rem;font-weight:600;color:#333}.status-percentage{font-size:.875rem;color:#666}@media (max-width:768px){.status-grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}.summary-header{flex-direction:column;align-items:flex-start}.total-count{margin-top:1rem;align-items:flex-start}}</style>
<div class="main-content project">   
    <div class="overlay"></div>   
<!-- Dashboard Overview -->
<div class="container-fluid">
    <!-- Page Title -->
    <div class="row">
        <div class="col-12">
            <div class="page-title-wrapper">
                <h1 class="page-title">
                    <span class="title-icon">
                        <i class="fas fa-chart-line" aria-hidden="true"></i>
                    </span>
                    <span class="title-text">Dashboard Overview</span>
                </h1>
            </div>
        </div>
    </div>
 
        <div class="dashboard-container" data-user-role="{{ user.roles.first.role|lower }}"> 
            <!-- Error Container -->
            <div id="dashboardErrors" class="mb-4"></div> 
           <!-- <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title">Uploaded Content & Businesses Gathered</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="timelineChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>-->
            <div class="row">
                <div class="col-12">
                  <div class="card">
                    <div class="card-header">
                      <div class="row align-items-center">
                        <div class="col">
                          <h5 class="card-title">Task Timeline</h5>
                        </div>
                        <div class="col-auto">
                          <div class="input-group">
                            <input type="date" id="start_date" class="form-control">
                            <input type="date" id="end_date" class="form-control">
                            <button id="filterDates" class="btn btn-primary">Filter</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="card-body">
                  
                        <!-- Timeline Chart -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <h6 class="text-muted text-uppercase mb-4">Timeline Overview</h6>
                                        <div class="chart-container" style="position: relative; height:400px; width:100%;">
                                            <canvas id="timelineChart"></canvas>
                                        </div>
                                        <div id="timelineError" class="alert alert-danger mt-3 d-none"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <!-- Total Tasks Card -->
                            <div class="col-md-6">
                                <div class="card border-0   shadow-sm">
                                    <div class="card-body text-center p-4">
                                      
                                        <h6 class="text-muted text-uppercase mb-2">Total Tasks</h6>
                                        <div class="d-flex align-items-center justify-content-center">
                                            <h4 id="totalTasks" class="display-4 mb-0 font-weight-bold">0</h4>
                                           
                                        </div>
                                        <p class="text-muted small mb-0 mt-2">
                                            <span id="tasksToday">0</span> tasks added today
                                        </p>
                                    </div>
                                </div>
                            </div>
                    
                            <!-- Total Businesses Card -->
                            <div class="col-md-6">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body text-center p-4">
                                         
                                        <h6 class="text-muted text-uppercase mb-2">Total Businesses</h6>
                                        <div class="d-flex align-items-center justify-content-center">
                                            <h4 id="totalBusinesses" class="display-4 mb-0 font-weight-bold">0</h4>
                                          
                                        </div>
                                        <p class="text-muted small mb-0 mt-2">
                                            <span id="businessesToday">0</span> businesses added today
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    
             
                    </div>
                    
                  </div>
                </div>
              </div>
               <!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 <script>
    class DashboardStats {
    constructor() {
        this.initializeCounters();
        this.initializeChart();
        this.loadStats();
    }

    initializeCounters() {
        this.counters = {
            tasks: document.getElementById('totalTasks'),
            businesses: document.getElementById('totalBusinesses'),
            tasksToday: document.getElementById('tasksToday'),
            businessesToday: document.getElementById('businessesToday'),
            tasksGrowth: document.getElementById('tasksGrowth'),
            businessGrowth: document.getElementById('businessGrowth'),
            pending: document.getElementById('pendingCount'),
            inProgress: document.getElementById('inProgressCount'),
            completed: document.getElementById('completedCount'),
            failed: document.getElementById('failedCount')
        };
    }

    async loadStats() {
        try {
            const response = await fetch('/api/dashboard/stats/');
            const data = await response.json();

            if (data.status === 'success') {
                this.updateCounters(data.data);
                this.updateChart(data.data.timeline);
            }
        } catch (error) {
            console.error('Error loading dashboard stats:', error);
        }
    }

    updateCounters(data) {
        // Animate counter updates
        this.animateCounter(this.counters.tasks, data.totalTasks);
        this.animateCounter(this.counters.businesses, data.totalBusinesses);
        
        // Update other stats
        this.counters.tasksToday.textContent = data.tasksToday;
        this.counters.businessesToday.textContent = data.businessesToday;
        this.counters.tasksGrowth.textContent = `${data.tasksGrowth}%`;
        this.counters.businessGrowth.textContent = `${data.businessGrowth}%`;
        
        // Update status counts
        this.animateCounter(this.counters.pending, data.statusCounts.PENDING);
        this.animateCounter(this.counters.inProgress, data.statusCounts.IN_PROGRESS);
        this.animateCounter(this.counters.completed, data.statusCounts.COMPLETED);
        this.animateCounter(this.counters.failed, data.statusCounts.FAILED);
    }

    animateCounter(element, target) {
        const duration = 1000;
        const start = parseInt(element.textContent);
        const range = target - start;
        const startTime = performance.now();

        const updateCounter = (currentTime) => {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);

            const current = Math.floor(start + (range * progress));
            element.textContent = current.toLocaleString();

            if (progress <script 1) {
                requestAnimationFrame(updateCounter);
            }
        };

        requestAnimationFrame(updateCounter);
    }
}

// Initialize dashboard
document.addEventListener('DOMContentLoaded', () => {
    new DashboardStats();
});

</script>
<script>
class TaskTimeline {
    constructor() {
        this.chart = null;
        this.defaultStartDate = new Date();
        this.defaultEndDate = new Date();
        // Set default start date to 30 days ago
        this.defaultStartDate.setDate(this.defaultStartDate.getDate() - 30);
        this.initialize();
    }
  
    initialize() {
        try {
            const canvas = document.getElementById('timelineChart');
            if (!canvas) {
                throw new Error('Timeline chart canvas not found');
            }
            this.initializeDatePickers();
            this.initializeFilterButton();
            this.loadTimelineData();
        } catch (error) {
            console.error('Initialization error:', error);
            this.showError(error.message);
        }
    }
  
    initializeDatePickers() {
        const startDateInput = document.getElementById('start_date');
        const endDateInput = document.getElementById('end_date');
  
        if (!startDateInput || !endDateInput) {
            throw new Error('Date picker inputs not found');
        }
  
        // Set default dates
        startDateInput.value = this.formatDate(this.defaultStartDate);
        endDateInput.value = this.formatDate(this.defaultEndDate);
  
        // Validate dates on change
        startDateInput.addEventListener('change', () => this.validateDates());
        endDateInput.addEventListener('change', () => this.validateDates());
    }
  
    formatDate(date) {
        return date.toISOString().split('T')[0];
    }
  
    validateDates() {
        const startDate = new Date(document.getElementById('start_date').value);
        const endDate = new Date(document.getElementById('end_date').value);
  
        if (startDate > endDate) {
            this.showError('Start date cannot be after end date');
            return false;
        }
  
        if (endDate > new Date()) {
            this.showError('End date cannot be in the future');
            return false;
        }
  
        this.hideError();
        return true;
    }
  
    initializeFilterButton() {
        const filterButton = document.getElementById('filterDates');
        if (!filterButton) {
            throw new Error('Filter button not found');
        }
  
        filterButton.addEventListener('click', () => {
            if (this.validateDates()) {
                this.loadTimelineData();
            }
        });
    }
  
    async loadTimelineData() {
        try {
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
  
            this.showLoading();
  
            const params = new URLSearchParams({
                start_date: startDate,
                end_date: endDate
            });
  
            const response = await fetch(`/api/dashboard/task-timeline/?${params}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
  
            const result = await response.json();
            console.log('Raw API response:', result);
  
            if (!result || result.status !== 'success' || !Array.isArray(result.data)) {
                throw new Error('Invalid data format received from server');
            }
  
            const transformedData = this.transformData(result.data);
            this.updateVisualization(transformedData);
  
            // Update totals if available
            if (result.totals) {
                this.updateTotals(result.totals.total_tasks, result.totals.total_businesses);
            }
  
        } catch (error) {
            console.error('Timeline data loading error:', error);
            this.showError(error.message);
        } finally {
            this.hideLoading();
        }
    }
  
    transformData(rawData) {
        if (!Array.isArray(rawData)) {
            console.error('Expected array for rawData, got:', typeof rawData);
            return { dates: [], taskCounts: [], businessCounts: [] };
        }
  
        // Sort rawData by date
        const sortedData = [...rawData].sort((a, b) => new Date(a.date) - new Date(b.date));
  
        return {
            dates: sortedData.map(item => item.date),
            taskCounts: sortedData.map(item => item.tasks_count || 0),
            businessCounts: sortedData.map(item => item.businesses_count || 0)
        };
    }
  
    updateTotals(totalTasks, totalBusinesses) {
        const totalTasksElement = document.getElementById('totalTasks');
        const totalBusinessesElement = document.getElementById('totalBusinesses');
        if (totalTasksElement) {
            totalTasksElement.textContent = totalTasks.toLocaleString();
        }
        if (totalBusinessesElement) {
            totalBusinessesElement.textContent = totalBusinesses.toLocaleString();
        }
    }
  
    updateVisualization(data) {
        if (!data || !data.dates || !data.taskCounts || !data.businessCounts) {
            console.error('Invalid data format for visualization:', data);
            return;
        }
        this.updateChart(data);
    }
  
    updateChart(data) {
        const canvas = document.getElementById('timelineChart');
        if (!canvas) {
            console.error('Timeline chart canvas not found');
            return;
        }
  
        // Obtain the 2D rendering context
        const ctx = canvas.getContext('2d');
  
        // Destroy any existing chart instance
        if (this.chart) {
            this.chart.destroy();
        }
  
        const chartData = {
            labels: data.dates,
            datasets: [
                {
                    label: 'Tasks',
                    data: data.taskCounts,
                    backgroundColor: 'rgba(33, 45, 148, 1)',
                    borderColor: 'rgba(33, 45, 148, 1)',
                    borderWidth: 1,
                    yAxisID: 'y-tasks'
                },
                {
                    label: 'Businesses',
                    data: data.businessCounts,
                    backgroundColor: 'rgba(244, 192, 49, 1)',
                    borderColor: 'rgba(244, 192, 49, 1)',
                    borderWidth: 1,
                    yAxisID: 'y-businesses'
                }
            ]
        };
        const options = {
  responsive: true,
  maintainAspectRatio: false,
  scales: {
    xAxes: [
      {
        type: 'category',
        scaleLabel: {
          display: true,
          labelString: 'Date'
        }
      }
    ],
    yAxes: [
      {
        id: 'y-tasks',
        type: 'linear',
        position: 'left',
        ticks: {
          beginAtZero: true
        },
        scaleLabel: {
          display: true,
          labelString: 'Tasks'
        }
      },
      {
        id: 'y-businesses',
        type: 'linear',
        position: 'right',
        ticks: {
          beginAtZero: true
        },
        gridLines: {
          drawOnChartArea: false
        },
        scaleLabel: {
          display: true,
          labelString: 'Businesses'
        }
      }
    ]
  },
  plugins: {
    tooltip: {
      mode: 'index',
      intersect: false
    },
    legend: {
      position: 'top'
    }
  }
};

        try {
            this.chart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: options
            });
        } catch (error) {
            console.error('Error creating chart:', error);
            this.showError('Failed to create chart');
        }
    }
  
    showLoading() {
        const chartContainer = document.getElementById('timelineChart')?.parentElement;
        if (chartContainer) {
            chartContainer.style.opacity = '0.5';
            if (!chartContainer.querySelector('.loading-spinner')) {
                const spinner = document.createElement('div');
                spinner.className = 'loading-spinner';
                spinner.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                `;
                chartContainer.appendChild(spinner);
            }
        }
    }
  
    hideLoading() {
        const chartContainer = document.getElementById('timelineChart')?.parentElement;
        if (chartContainer) {
            chartContainer.style.opacity = '1';
            const spinner = chartContainer.querySelector('.loading-spinner');
            if (spinner) {
                spinner.remove();
            }
        }
    }
  
    showError(message) {
        console.error(message);
        const errorContainer = document.getElementById('timelineError');
        if (errorContainer) {
            errorContainer.textContent = message;
            errorContainer.classList.remove('d-none');
        }
    }
  
    hideError() {
        const errorContainer = document.getElementById('timelineError');
        if (errorContainer) {
            errorContainer.classList.add('d-none');
        }
    }
}
  
// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new TaskTimeline();
});
</script>

            <!-- Date Filters and Totals -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <div class="col">
                                <h5 class="card-title">Business Status Distribution</h5>
                              </div> 
                            <button id="refreshBusinessStats" class="btn btn-sm btn-primary">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="position: relative; height:400px; width:100%">
                                <canvas id="businessStatusChart"></canvas>
                            </div>
                            
                            <div id="chartSummary" class="mt-4">
                                <div class="chart-summary-container">
                                    <div class="summary-header">
                                        <h6 class="summary-title">Status Distribution</h6>
                                        <div class="total-count">
                                            <span class="total-label">Total Businesses</span>
                                            <span id="totalBusinesses" class="total-number">0</span>
                                        </div>
                                    </div>
                                    
                                    <div class="status-grid">
                                        <div class="status-card">
                                            <div class="status-info">
                                                <div class="status-dot" style="background: rgba(220, 53, 69, 0.8)"></div>
                                                <span class="status-label">Discarded</span>
                                            </div>
                                            <div class="status-numbers">
                                                <span id="discardedCount" class="status-count">0</span>
                                                <span id="discardedPercentage" class="status-percentage">0%</span>
                                            </div>
                                        </div>
                
                                        <div class="status-card">
                                            <div class="status-info">
                                                <div class="status-dot" style="background: rgba(255, 193, 7, 0.8)"></div>
                                                <span class="status-label">Pending</span>
                                            </div>
                                            <div class="status-numbers">
                                                <span id="pendingCount" class="status-count">0</span>
                                                <span id="pendingPercentage" class="status-percentage">0%</span>
                                            </div>
                                        </div>
                
                                        <div class="status-card">
                                            <div class="status-info">
                                                <div class="status-dot" style="background: rgba(40, 167, 69, 0.8)"></div>
                                                <span class="status-label">Reviewed</span>
                                            </div>
                                            <div class="status-numbers">
                                                <span id="reviewedCount" class="status-count">0</span>
                                                <span id="reviewedPercentage" class="status-percentage">0%</span>
                                            </div>
                                        </div>
                
                                        <div class="status-card">
                                            <div class="status-info">
                                                <div class="status-dot" style="background: rgba(23, 162, 184, 0.8)"></div>
                                                <span class="status-label">In Production</span>
                                            </div>
                                            <div class="status-numbers">
                                                <span id="productionCount" class="status-count">0</span>
                                                <span id="productionPercentage" class="status-percentage">0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <script>
                class BusinessStatusChart {
                    constructor() {
                        this.chart = null;
                        this.chartColors = {
                            discarded: 'rgba(220, 53, 69, 0.8)',
                            pending: 'rgba(255, 193, 7, 0.8)',
                            reviewed: 'rgba(40, 167, 69, 0.8)',
                            in_production: 'rgba(23, 162, 184, 0.8)'
                        };
                        this.initialize();
                    }
                
                    async initialize() {
                        await this.loadData();
                        this.setupRefreshButton();
                    }
                
                    setupRefreshButton() {
                        document.getElementById('refreshBusinessStats')?.addEventListener('click', () => {
                            this.loadData();
                        });
                    }
                
                    async loadData() {
                        try {
                            const response = await fetch('/api/dashboard/business-status/');
                            const result = await response.json();
                            
                            if (result.status === 'success') {
                                this.updateChart(result.data);
                                this.updateSummary(result.data);
                            }
                        } catch (error) {
                            console.error('Error loading business status data:', error);
                        }
                    }
                
                    updateChart(data) {
                        const ctx = document.getElementById('businessStatusChart');
                        if (!ctx) return;
                
                        if (this.chart) {
                            this.chart.destroy();
                        }
                
                        this.chart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Discarded', 'Pending', 'Reviewed', 'In Production'],
                                datasets: [{
                                    label: 'Number of Businesses',
                                    data: [
                                        data.discarded,
                                        data.pending,
                                        data.reviewed,
                                        data.in_production
                                    ],
                                    backgroundColor: Object.values(this.chartColors),
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            stepSize: 1
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        display: false
                                    }
                                }
                            }
                        });
                    }
                
                    updateSummary(data) {
                        const total = data.discarded + data.pending + data.reviewed + data.in_production;
                        
                        // Update total
                        document.getElementById('totalBusinesses').textContent = total;
                
                        // Update individual counts and percentages
                        this.updateStatusCard('discarded', data.discarded, total);
                        this.updateStatusCard('pending', data.pending, total);
                        this.updateStatusCard('reviewed', data.reviewed, total);
                        this.updateStatusCard('production', data.in_production, total);
                    }
                
                    updateStatusCard(status, count, total) {
                        document.getElementById(`${status}Count`).textContent = count;
                        const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                        document.getElementById(`${status}Percentage`).textContent = `${percentage}%`;
                    }
                }
                
                // Initialize when DOM is loaded
                document.addEventListener('DOMContentLoaded', () => {
                    new BusinessStatusChart();
                });
                </script>
                
            <div class="col-12">
            <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
           
                <div class="col">
                    <h5 class="card-title">Recent Projects</h5>
                  </div> 
                <div>
                    <button id="refreshProjects" class="btn btn-sm btn-primary me-2">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <a href="/tasks/" class="btn btn-secondary btn-sm">View all tasks</a>
                </div>
            </div>
            <div class="card-body">
                <!-- Add loading indicator -->
                <div id="projectsLoading" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                
                <!-- Projects grid container -->
                <div id="recentProjectsGrid" class="row g-3"></div>
                
                <!-- Error message container -->
                <div id="projectsError" class="alert alert-danger d-none"></div>
            </div>
            </div>
            </div>
                
            <script>
            class RecentProjects {
                constructor() {
                    this.apiUrl = '/api/dashboard/recent-tasks/';
                    this.currentLimit = 12;  // Initial load
                    this.incrementBy = 12;    
                    this.projects = [];
                    this.totalCount = 0;
                    this.initialize();
                }

                async initialize() {
                    await this.loadRecentProjects();
                    this.setupRefreshButton();
                    this.setupShowMoreButton();
                    this.setupAutoRefresh();
                }

                setupRefreshButton() {
                    const refreshBtn = document.getElementById('refreshProjects');
                    if (refreshBtn) {
                        refreshBtn.addEventListener('click', () => {
                            this.currentLimit = 12;
                            this.loadRecentProjects();
                        });
                    }
                }

                setupShowMoreButton() {
                    let showMoreBtn = document.getElementById('showMoreProjects');
                    if (!showMoreBtn) {
                        const container = document.getElementById('recentProjectsGrid');
                        showMoreBtn = document.createElement('button');
                        showMoreBtn.id = 'showMoreProjects';
                        showMoreBtn.className = 'btn btn-primary mt-3';
                        showMoreBtn.textContent = 'Show More';
                        container.parentNode.insertBefore(showMoreBtn, container.nextSibling);
                    }

                    showMoreBtn.addEventListener('click', () => {
                        this.currentLimit += this.incrementBy;
                        this.loadRecentProjects();
                    });
                }

                setupAutoRefresh() {
                    setInterval(() => this.loadRecentProjects(), 30000);
                }

                async loadRecentProjects() {
                    try {
                        const url = `${this.apiUrl}?limit=${this.currentLimit}`;
                        console.log('Fetching from:', url);

                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const responseData = await response.json();
                        console.log('Recent projects data received:', responseData);

                        if (responseData.status === "success" && Array.isArray(responseData.data)) {
                            this.projects = responseData.data;
                            this.renderProjects(this.projects);
                            this.updateShowMoreButton(responseData.total_count);
                        } else {
                            console.error('Unexpected data format:', responseData);
                            this.showError('Unexpected response format from server.');
                        }
                    } catch (error) {
                        console.error('Error loading recent projects:', error);
                        this.showError('Failed to load recent projects');
                    }
                }

                updateShowMoreButton(totalCount) {
                    const showMoreBtn = document.getElementById('showMoreProjects');
                    if (showMoreBtn) {
                        if (this.projects.length >= totalCount) {
                            showMoreBtn.style.display = 'none';
                        } else {
                            showMoreBtn.style.display = 'block';
                            showMoreBtn.textContent = `Show ${this.incrementBy} More (${this.projects.length}/${totalCount})`;
                        }
                    }
                }

                renderProjects(projects) {
                    const container = document.getElementById('recentProjectsGrid');
                    if (!container) {
                        console.error('Projects container not found');
                        return;
                    }

                    if (!projects.length) {
                        container.innerHTML = `
                            <div class="col-12">
                                <div class="alert alert-info">
                                    No projects found.
                                </div>
                            </div>`;
                        return;
                    }

                    const projectsHtml = projects.map(project => `
                        <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                            <div class="modern-card">
                                <div class="card-content">
                                    <div class="card-header-flex">
                                        <span class="task-id">#${project.id}</span>
                                        <span class="status-badge ${this.getStatusClass(project.status)}">
                                            ${this.formatStatus(project.status)}
                                        </span>
                                    </div>

                                    <a href="/task/${project.id}/" class="task-title" title="${this.escapeHtml(project.project_title)}">
                                        ${this.escapeHtml(project.project_title)}
                                    </a>

                                    <div class="info-grid">
                                        <div class="info-row">
                                            <span class="info-label">Destination:</span>
                                            <span class="info-value">${this.escapeHtml(project.destination?.name || 'N/A')}</span>
                                        </div>

                                        <div class="info-row">
                                            <span class="info-label">Created:</span>
                                            <span class="info-value">${this.formatDate(project.created_at)}</span>
                                        </div>

                                        <div class="info-row">
                                            <span class="info-label">User:</span>
                                            <span class="info-value text-truncate" title="${this.escapeHtml(project.user?.username || 'N/A')}">
                                                ${this.escapeHtml(project.user?.username || 'N/A')}
                                            </span>
                                        </div>

                                        <div class="info-row">
                                            <span class="info-label">Businesses:</span>
                                            <span class="info-value">${project.business_count || 0}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    container.innerHTML = projectsHtml;
                }

                getStatusClass(status) {
                    const statusClasses = {
                        'DONE': 'status-live',
                        'IN_PROGRESS': 'status-progress',
                        'COMPLETED': 'status-complete',
                        'FAILED': 'status-failed',
                        'PENDING': 'status-pending',
                        'READY TO REVIEW': 'status-review'
                    };
                    return statusClasses[status] || 'status-default';
                }

                formatStatus(status) {
                    if (!status) return 'Unknown';
                    return status.replace(/_/g, ' ').toLowerCase()
                        .replace(/\b\w/g, l => l.toUpperCase());
                }

                formatDate(dateString) {
                    if (!dateString) return 'N/A';
                    try {
                        const date = new Date(dateString.replace(' ', 'T'));
                        return date.toLocaleString('en-US', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch (error) {
                        console.error('Date formatting error:', error);
                        return dateString;
                    }
                }

                escapeHtml(unsafe) {
                    if (!unsafe) return '';
                    return unsafe.toString()
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");
                }

                showError(message) {
                    const container = document.getElementById('recentProjectsGrid');
                    if (container) {
                        container.innerHTML = `<p class="error-message">${message}</p>`;
                    }
                }
            }

            // Initialize when DOM is loaded
            document.addEventListener('DOMContentLoaded', () => {
                window.recentProjectsInstance = new RecentProjects();
            });
            
            </script>
                
                <style>
                .modern-card {
                    background: #fff;
                    border-radius: 0.5rem;
                    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
                    transition: transform 0.2s ease-in-out;
                }
                
                .modern-card:hover {
                    transform: translateY(-3px);
                }
                
                .card-content {
                    padding: 1.25rem;
                }
                
                .card-header-flex {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 1rem;
                }
                
                .task-id {
                    font-size: 0.875rem;
                    color: #858796;
                    font-weight: 600;
                }
                
                .status-badge {
                    padding: 0.25rem 0.75rem;
                    border-radius: 1rem;
                    font-size: 0.75rem;
                    font-weight: 600;
                    text-transform: uppercase;
                }
                
                .status-review { background: #f6c23e; color: #fff; }
                .status-live { background: #1cc88a; color: #fff; }
                .status-progress { background: #4e73df; color: #fff; }
                .status-complete { background: #36b9cc; color: #fff; }
                .status-failed { background: #e74a3b; color: #fff; }
                .status-default { background: #858796; color: #fff; }
                
                .task-title {
                    display: block;
                    color: #5a5c69;
                    font-weight: 600;
                    font-size: 1rem;
                    margin-bottom: 1rem;
                    text-decoration: none;
                    line-height: 1.4;
                    min-height: 2.8em;
                }
                
                .task-title:hover {
                    color: #4e73df;
                    text-decoration: none;
                }
                
                .info-grid {
                    display: grid;
                    gap: 0.5rem;
                }
                
                .info-row {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    font-size: 0.875rem;
                }
                
                .info-label {
                    color: #858796;
                }
                
                .info-value {
                    color: #5a5c69;
                    font-weight: 600;
                }
                
                .text-truncate {
                    max-width: 150px;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                }
                
                @media (max-width: 576px) {
                    .modern-card {
                        margin-bottom: 1rem;
                    }
                }
                </style>
                 
                <!-- Ambassador Section (only visible for ambassadors) -->
                <div class="row ambassador-section" style="display: none;">
                    <div class="col-12 mb-4">
                        <div class="card shadow">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">My Destinations Overview</h6>
                            </div>
                            <div class="card-body">
                                <div id="ambassadorDestinations">
                                    <!-- Ambassador-specific content will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

                    <!-- Modals -->
                    <div class="modal fade" id="taskDetailsModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Task Details</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body" id="taskDetailsContent">
                                    <!-- Task details will be populated here -->
          
                    </div>
                </div>
            </div>
        </div>
        
        </div>   
 
 
        
        <script>
            // Define your dashboard configuration
            const DASHBOARD_CONFIG = {
                charts: {
                    colors: {
                        primary: '#4e73df',
                        success: '#1cc88a',
                        info: '#36b9cc',
                        warning: '#f6c23e',
                        danger: '#e74a3b',
                        dark: '#5a5c69',
                        light: '#ffffff'
                    }
                },
                api: {
                    refreshInterval: 300000 // 5 minutes
                },
                errors: {
                    displayDuration: 5000 // 5 seconds
                }
            };
        </script>
</div> 
</div>
{% endblock %}
