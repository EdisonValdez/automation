{% extends "base.html" %}
{% load business_filters %}
{% block title %}{{ task.project_title }}{% endblock %}
{% block content %}
<style> .business-title {font-size: 1em;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;margin: 0;}.business-link {display: block;color: inherit;text-decoration: none;padding: 5px 0;width: 100%;}.business-link:hover {color: #007bff;text-decoration: underline;}small {font-size: 10px;}#taskDetailsContainer {transition: all 0.3s ease-in-out;}.kanban-cont {display: flex;overflow-x: auto;padding-bottom: 10px;gap: 10px;}.kanban-list {flex: 1 1 30%;min-width: 250px;max-width: 100%;background-color: #f4f5f7;border-radius: 5px;margin: 5px;}.kanban-box {background-color: white;border-radius: 5px;padding: 10px;box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);display: flex;flex-direction: column;cursor: move;}.image-container {position: relative;overflow: hidden;width: 100%;height: auto;}.thumbnail-image {width: 100%;height: auto;max-height: 200px;object-fit: cover;}.image-overlay {position: absolute;bottom: 0;left: 0;right: 0;background-color: rgba(0, 0, 0, 0.7);overflow: hidden;width: 100%;height: 0;transition: 0.5s ease;}.image-container:hover .image-overlay {height: 100%;}.overlay-title {color: white;font-size: 16px;position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);text-align: center;width: 90%;}.business-stats {display: flex;justify-content: space-between;margin-top: 10px;font-size: 10px;}.kanban-header {margin-bottom: 10px;padding: 10px;background-color: #e4e6e9;border-radius: 5px;}.kanban-wrap {max-height: 800px;overflow-y: auto;}.load-more {width: 100%;margin-top: 10px;}@media (max-width: 768px) {.kanban-list {flex-basis: 100%;min-width: 100%;margin-right: 0;}.kanban-header, .kanban-box {padding: 8px;}.overlay-title {font-size: 14px;}}@media (max-width: 576px) {.kanban-cont {padding: 0;gap: 5px;}.kanban-box {padding: 5px;}.thumbnail-image {max-height: 150px;}.business-stats {font-size: 8px;}.overlay-title {font-size: 12px;}}</style>
<div id="loading-spinner" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
    </div>
</div>
<div class="main-content project"> 
    <div class="row">
        <div class="col-12">
            <div class="page-title-wrapper">
                <h1 class="page-title">
                    <span class="title-icon">
                        <i class="fas fa-tasks"></i>
                    </span>
                    <span class="title-text"><strong>Kanban Board:</strong> {{ task.project_title }} - Total: {{ businesses|length }} 
                    </span>
                </h1>
            </div>
        </div>
    </div> 
<div class="col-12">
    <div class="row">
        
        <div class="col-xl-3 col-lg-3 col-md-6 col-sm-12"></div>

        <div class="col-xl-3 col-lg-3 col-md-6 col-sm-12">
            <div class="mb-3">
                <input type="text" id="business-search" class="form-control" placeholder="Search businesses...">
            </div>
        </div>
        <div class="col-xl-3 col-lg-3 col-md-6 col-sm-12">
            <div class="mb-3">
                <select id="business-sort" class="form-control">
                    <option value="rank">Sort by Rank</option>
                    <option value="reviews">Sort by Number of Reviews</option>
                    <option value="rating">Sort by Average Rating</option>
                </select>
            </div>
        </div>
        <div class="col-xl-3 col-lg-3 col-md-6 col-sm-12">
            <div class="mb-3">
                <select id="rating-range" class="form-control">
                    <option value="">Todas las calificaciones</option>
                    <option value="5.0-4.5">5.0 - 4.5</option>
                    <option value="4.4-4.0">4.4 - 4.0</option>
                    <option value="3.9-3.5">3.9 - 3.5</option>
                    <option value="3.4-3.0">3.4 - 3.0</option>
                    <option value="2.9-0">2.9 - 0</option>
                </select>
            </div>
        </div>
    </div>
    <div class="kanban-board card mb-0 pd-0">
        <div class="box-body pd-0">
            <div class="kanban-cont">
                {% for status, status_name in status_choices %}
                {% if status != 'IN_PRODUCTION' or user.is_admin %}
                <div class="kanban-list {% if status == 'DISCARDED' %} kanban-list-discarded {% else %} {% if user.is_admin %}narrow{% else %}wide{% endif %} {% endif %}" id="{{ status }}">
                    <div id="{{status}}" class="kanban-header">
                        <h6 id="{{ status }}" class="card-title {% if status == 'DISCARDED' %} text-danger {% endif %}">
                            {% if status == 'IN_PRODUCTION' %}
                            Move To APP
                            {% else %}
                            {{ status_name }} (<span class="status-count" data-status="{{ status }}">{{ businesses|filter_by_status:status|length }}</span>)
                            {% endif %}
 
                        </h6>
                    </div>
                    <div class="kanban-wrap" id="kanban-wrap-{{ status }}">
                        {% for business in businesses|filter_by_status:status %}
                        {% if business.status == status %}
                        <div class="panel" data-id="{{ business.id }}" data-status="{{ business.status }}">
                            <div class="kanban-box item-box">
                                <!-- <div class="dropdown edit">
                                    <a href="#" class="btn-link" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-pencil-alt"></i>
                                    </a>
                                    <div class="dropdown-menu dropdown-menu-right">
                                        <a class="dropdown-item" href="{% url 'business_detail' business.id %}">
                                            <i class="bx bx-show mr-5"></i>View
                                        </a>
                                       <a class="dropdown-item" href="#" data-toggle="modal" data-target="#edit_card_modal">
                                            <i class="bx bx-edit mr-5"></i>Edit
                                        </a>
                                    </div>
                                </div>-->
    
                                <!-- Title Box -->
                            <div class="title-box">
                                <h6 class="business-title text-truncate">
                                    <a href="{% url 'business_detail' business.id %}" class="business-link" title="{{ business.title }}">
                                        {{ business.title|truncatechars:20 }}
                                    </a>
                                </h6>   
                            </div>
    
                            <div class="content-box">
                                <small class="">
                                    <a href="https://www.google.com/maps/place/?q=place_id:{{ business.place_id }}" class="" target="_blank">
                                        <i class="bx bx-pin font-size-16 align-middle me-1"></i>{{ business.address|truncatechars:50 }}
                                    </a>
                                </small>                                     
                                    <div class="business-stats">
                                        <span class="rank">Rank: {{ business.rank|default:"N/A" }}</span>
                                        <span class="total-score">Total Score: {{ business.reviews_count|default:"N/A" }}</span>
                                        <span class="total-score">Avg: {{ business.rating|default:"N/A" }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    
      
</div>
 
{% if not businesses %}
    <p>No businesses found for this project.</p>
{% endif %}

    {% if not businesses %}
        <p>No businesses found for this project.</p>
    {% endif %}
   {% if user.is_admin %} 
    <a href="{% url 'upload_file' %}" class="btn btn-secondary mt-3">Back to Projects</a>
 {% else %}
 <a href="{% url 'task_list' %}" class="btn btn-secondary mt-3">Go To Task List</a>
{% endif %}
    <button id="scroll-to-top" class="btn btn-primary" style="display: none; position: fixed; bottom: 20px; right: 30px; z-index: 99;">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var containers = document.querySelectorAll('.kanban-wrap');
    containers.forEach(function(container) {
        new Sortable(container, {
            group: 'shared',
            animation: 150,
            onEnd: function(evt) {
                var itemEl = evt.item;
                var newStatus = evt.to.closest('.kanban-list').id;
                var oldStatus = evt.from.closest('.kanban-list').id;
                var businessId = itemEl.dataset.id;

                // Only proceed if the status has changed
                if (newStatus !== oldStatus) {
                    // Update the status in the backend
                    updateBusinessStatus(businessId, newStatus, oldStatus);
                }
            }
        });
    });
});

const userId = "{{ user.id }}"

function updateBusinessStatus(businessId, newStatus, oldStatus) {
    fetch(`/update-business-status/${businessId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            status: newStatus,
            userId: userId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Actualizar los contadores
            updateStatusCount(oldStatus, -1);
            updateStatusCount(newStatus, 1);
            // Actualizar el atributo data-status del elemento movido
            document.querySelector(`.panel[data-id="${businessId}"]`).dataset.status = newStatus;
        } else if (data.status === 'move-to-app-error'){
            Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message,
                    confirmButtonText: 'OK'
                });
                revertToOldColumn(businessId, oldStatus);

        }else {   
            Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Cannot move to the next column. Business description is missing.',
                    confirmButtonText: 'OK'
                });
                revertToOldColumn(businessId, oldStatus);
        }
    })
    .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Unable to validate business details. Please try again.',
                confirmButtonText: 'OK'
            });
            revertToOldColumn(businessId, oldStatus);
        });
}

function revertToOldColumn(businessId, oldStatus) {
    const oldColumn = document.querySelector(`#kanban-wrap-${oldStatus}`);
    const itemEl = document.querySelector(`.panel[data-id="${businessId}"]`);
    if (oldColumn && itemEl) {
        oldColumn.appendChild(itemEl);
    }
}
 

function updateStatusCount(status, change) {
    var countElement = document.querySelector(`.status-count[data-status="${status}"]`);
    if (countElement) {
        var currentCount = parseInt(countElement.textContent);
        countElement.textContent = currentCount + change;
    }
}


// Función para obtener el token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
 
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var kanbanLists = document.querySelectorAll('.kanban-wrap');
        
        kanbanLists.forEach(function(list) {
            new Sortable(list, {
                group: 'shared',
                animation: 150,
                onEnd: function(evt) {
                var itemEl = evt.item;
                var newStatus = evt.to.closest('.kanban-list').id;
                var oldStatus = evt.from.closest('.kanban-list').id;
                var businessId = itemEl.dataset.id;
                updateBusinessStatus(businessId, newStatus, oldStatus);
            }

            });
        });
    
        function updateBusinessStatus(businessId, newStatus) {
            fetch(`/update-business-status/${businessId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `status=${newStatus}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log(`Business ${businessId} status updated to ${newStatus}`);
                } else {
                    console.error('Error updating business status');
                    // You might want to move the item back to its original position here
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
    
        function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButton = document.getElementById('toggleTaskDetails');
        const taskDetailsContainer = document.getElementById('taskDetailsContainer');
        
        // Get the saved state from localStorage, default to true if not set
        let isVisible = localStorage.getItem('taskDetailsVisible') !== 'false';
        
        // Set initial state based on saved preference
        if (!isVisible) {
            taskDetailsContainer.style.display = 'none';
            toggleButton.textContent = 'Show Task Details';
        }
        
        toggleButton.addEventListener('click', function() {
            if (isVisible) {
                taskDetailsContainer.style.display = 'none';
                toggleButton.textContent = 'Show Task Details';
            } else {
                taskDetailsContainer.style.display = 'block';
                toggleButton.textContent = 'Hide Task Details';
            }
            isVisible = !isVisible;
            
            // Save the new state to localStorage
            localStorage.setItem('taskDetailsVisible', isVisible);
        });
    });
</script>

<script>
    $(document).ready(function() {
        // Existing functionalities...
    
        // Sorting functionality
        $('#business-sort').change(function() {
            var sortBy = $(this).val();
            $('.kanban-wrap').each(function() {
                var $wrap = $(this);
                var $businesses = $wrap.find('.panel').get();
                $businesses.sort(function(a, b) {
                    var aValue, bValue;
                    if (sortBy === 'rank') {
                        aValue = parseInt($(a).find('.rank').text().split(':')[1]) || 0;
                        bValue = parseInt($(b).find('.rank').text().split(':')[1]) || 0;
                    } else if (sortBy === 'reviews') {
                        aValue = parseInt($(a).find('.total-score').first().text().split(':')[1]) || 0;
                        bValue = parseInt($(b).find('.total-score').first().text().split(':')[1]) || 0;
                    } else if (sortBy === 'rating') {
                        aValue = parseFloat($(a).find('.total-score').last().text().split(':')[1]) || 0;
                        bValue = parseFloat($(b).find('.total-score').last().text().split(':')[1]) || 0;
                    }
                    return bValue - aValue; // Sort in descending order
                });
                $.each($businesses, function(idx, item) { $wrap.append(item); });
            });
        });
    });
</script>

<script>
    $(document).ready(function() {
        $('.load-more').click(function() {
            var button = $(this);
            var status = button.data('status');
            var page = button.data('page');
            
            $('#loading-spinner').show();
            
            $.ajax({
                url: '{% url "load_more_businesses" %}',
                data: {
                    'status': status,
                    'page': page,
                    'task_id': '{{ task.id }}'
                },
                success: function(data) {
                    $('#kanban-wrap-' + status).append(data.html);
                    if (data.has_more) {
                        button.data('page', page + 1);
                    } else {
                        button.hide();
                    }
                    $('#loading-spinner').hide();
                },
                error: function() {
                    alert('Error loading more businesses. Please try again.');
                    $('#loading-spinner').hide();
                }
            });
        });
    });
</script>

<script>
$(document).ready(function() {
    // Existing load-more functionality...

    // Scroll to top functionality
    $(window).scroll(function() {
        if ($(this).scrollTop() > 100) {
            $('#scroll-to-top').fadeIn();
        } else {
            $('#scroll-to-top').fadeOut();
        }
    });

    $('#scroll-to-top').click(function() {
        $('html, body').animate({scrollTop : 0}, 800);
        return false;
    });

    // Smooth scrolling for kanban lists
    $('.kanban-wrap').scroll(function() {
        if ($(this).scrollTop() > 100) {
            $(this).find('.scroll-to-top').fadeIn();
        } else {
            $(this).find('.scroll-to-top').fadeOut();
        }
    });

    $('.scroll-to-top').click(function() {
        $(this).closest('.kanban-wrap').animate({scrollTop : 0}, 800);
        return false;
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
const translatingButtons = document.querySelectorAll('.start-translating-btn');

translatingButtons.forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();
        
        if (this.classList.contains('disabled')) {
            return;
        }
        
        this.classList.add('disabled');
        this.textContent = 'Translating and Enhancing...';
        
        const taskId = this.getAttribute('data-task-id');
        
        fetch(`/tasks/${taskId}/translate/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                this.textContent = 'Translation and Enhancement Complete';
            } else {
                this.textContent = 'Error Translating and Enhancing';
                this.classList.remove('disabled');
            }
            console.log(data.message);
        })
        .catch(error => {
            console.error('Error:', error);
            this.textContent = 'Error Translating and Enhancing';
            this.classList.remove('disabled');
        });
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
});
</script>

<script>
    $(document).ready(function() {
    // Improved search function with debouncing
    let searchTimeout;
    
    function searchBusinesses(searchTerm) {
        searchTerm = searchTerm.toLowerCase().trim();
        console.log('Searching for:', searchTerm); // Debugging

        $('.panel').each(function() {
            const $panel = $(this);
            const businessTitle = $panel.find('.overlay-title').text().toLowerCase();
            const businessAddress = $panel.find('.content-box p').text().toLowerCase();
            
            // Debug log
            console.log('Business:', businessTitle);
            console.log('Address:', businessAddress);

            // More comprehensive search
            const matchesSearch = 
                businessTitle.includes(searchTerm) || 
                businessAddress.includes(searchTerm) ||
                $panel.text().toLowerCase().includes(searchTerm);

            $panel.toggle(matchesSearch);
        });

        // Log number of visible results
        console.log('Visible results:', $('.panel:visible').length);
    }

    // Enhanced filter function
    function applyAllFilters() {
        const searchTerm = $('#business-search').val().toLowerCase().trim();
        const ratingRange = $('#rating-range').val();
        const [maxRating, minRating] = ratingRange ? ratingRange.split('-').map(Number) : [5, 0];

        $('.panel').each(function() {
            const $panel = $(this);
            const businessTitle = $panel.find('.overlay-title').text().toLowerCase();
            const businessAddress = $panel.find('.content-box p').text().toLowerCase();
            const avgRating = parseFloat($panel.find('.total-score').last().text().split(':')[1]) || 0;

            // More comprehensive matching
            const matchesSearch = searchTerm === '' || 
                businessTitle.includes(searchTerm) || 
                businessAddress.includes(searchTerm) ||
                $panel.text().toLowerCase().includes(searchTerm);
            
            const matchesRating = avgRating >= minRating && avgRating <= maxRating;

            $panel.toggle(matchesSearch && matchesRating);
        });

        // Log filtered results
        console.log('Filtered results:', $('.panel:visible').length);
    }

    // Debounced search input handler
    $('#business-search').on('input', function() {
        clearTimeout(searchTimeout);
        const searchTerm = $(this).val();
        
        // Show loading indicator if needed
        // $('.loading-indicator').show();

        searchTimeout = setTimeout(() => {
            applyAllFilters();
            // $('.loading-indicator').hide();
        }, 300); // 300ms delay
    });

    // Rating range filter
    $('#rating-range').change(function() {
        applyAllFilters();
    });

    // Enhanced sorting function
    $('#business-sort').change(function() {
        const sortBy = $(this).val();
        
        $('.kanban-wrap').each(function() {
            const $wrap = $(this);
            const $businesses = $wrap.find('.panel:visible').get();

            $businesses.sort(function(a, b) {
                let aValue, bValue;
                const $a = $(a);
                const $b = $(b);

                switch(sortBy) {
                    case 'rank':
                        aValue = parseInt($a.find('.rank').text().split(':')[1]) || 0;
                        bValue = parseInt($b.find('.rank').text().split(':')[1]) || 0;
                        break;
                    case 'reviews':
                        aValue = parseInt($a.find('.total-score').first().text().split(':')[1]) || 0;
                        bValue = parseInt($b.find('.total-score').first().text().split(':')[1]) || 0;
                        break;
                    case 'rating':
                        aValue = parseFloat($a.find('.total-score').last().text().split(':')[1]) || 0;
                        bValue = parseFloat($b.find('.total-score').last().text().split(':')[1]) || 0;
                        break;
                }
                return bValue - aValue;
            });

            $wrap.append($businesses);
        });
    });

    // Add these helper functions for debugging
    function logPanelStructure() {
        console.log('Panel Structure:');
        $('.panel').first().each(function() {
            console.log('Overlay Title:', $(this).find('.overlay-title').text());
            console.log('Content Box Text:', $(this).find('.content-box p').text());
            console.log('Total Score:', $(this).find('.total-score').text());
        });
    }

    // Call this on page load
    logPanelStructure();
});

</script>
{% endblock %}