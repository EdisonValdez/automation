{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="main-content project"> 
    <div class="row">
        <div class="col-12">
            <div class="page-title-wrapper">
                <h1 class="page-title">
                    <span class="title-icon">
                        <i class="fas fa-tasks"></i>
                    </span>
                    <span class="title-text">Content List</span>
                </h1>
            </div> 
                    <!--Recent Activity--> 
                        <div class="box-body pb-0 table-responsive activity">
                                <table class="table table-vcenter text-nowrap table-bordered dataTable no-footer mw-100" id="task-activity" role="grid">
                                    <thead>
                                        <tr>
                                            <th>Project</th>
                                            <th>Start</th>
                                            <th>Business(es)</th> 
                                            <th>Work Status</th>
                                            <th>Translated Status</th>
                                            <th>Action</th>
                                        </tr>
                                        <tr> 
                                            <th><input type="text" placeholder="Search Project" /></th>
                                            <th><input type="text" placeholder="Search Start Date" /></th>
                                            <th><input type="text" placeholder="Search Businesses" /></th>
                                            <th><input type="text" placeholder="Search Work Status" /></th>
                                            <th><input type="text" placeholder="Search Translated Status" /></th>
                                            <th></th>
                                        </tr>
                                        </thead>
                                <tbody>
                                    {% for task in tasks %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'task_detail' task.id %}" class="d-flex">
                                                <span>{{ task.id }} - {{ task.project_title }}</span>
                                            </a>
                                        </td>
                                        <td>{{ task.created_at|date:"d-m-Y" }}</td>
                                        <td>  {{ task.businesses.count }} </td>
                                        <td>
                                            <span class="badge {% if task.status == 'IN_PROGRESS' %} badge-success {% elif task.status == 'PENDING' %} badge-warning {% elif task.status == 'FAILED' %} badge-danger {% elif task.status == 'COMPLETED' %} badge-primary {% endif %}">
                                                {{ task.get_status_display }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge {% if task.translation_status == 'PENDING_TRANSLATION' %} badge-warning {% elif task.translation_status == 'TRANSLATION_FAILED' %} badge-danger {% elif task.translation_status == 'TRANSLATED' %} badge-success {% endif %}">
                                                {{ task.translation_status }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="dropdown">
                                                <a href="#" class="btn-link" data-bs-toggle="dropdown" aria-expanded="false">
                                                    <i class="bx bx-dots-horizontal-rounded"></i>
                                                </a>
                                                <div class="dropdown-menu dropdown-menu-right">
                                                    {% if task.translation_status != 'TRANSLATED' %}
                                                    <a class="dropdown-item start-translating-btn" href="#" data-task-id="{{ task.id }}">
                                                        <i class="fas fa-sync"></i> Translate and Enhance
                                                    </a>
                                                    {% elif task.translation_status == 'PENDING_TRANSLATION' %}
                                                    <a class="dropdown-item start-translating-btn" href="#" data-task-id="{{ task.id }}">
                                                        <i class="fas fa-sync danger"></i> Translate and Enhance
                                                    </a>
                                                    {% endif %}
                                                    <a class="dropdown-item" href="{% url 'task_detail' task.id %}">
                                                        <i class="bx bx-info-circle font-size-16 align-middle me-1"></i>View
                                                    </a>
                                                    {% if user.is_admin %}
                                                    <a class="dropdown-item delete-task-btn" href="#" data-task-id="{{ task.id }}">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </a>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </td>  
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5">No tasks found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                    
                                    
                                </table> 
                                <!-- Paginator with Custom Styling -->
                                <div class="pagination">
                                <span class="step-links">
                                    {% if page_obj.has_previous %}
                                        <a href="?page=1" class="btn btn-outline-primary">&laquo; First</a>
                                        <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline-primary">Previous</a>
                                    {% endif %}
                    
                                    <span class="current">
                                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
                                    </span>
                    
                                    {% if page_obj.has_next %}
                                        <a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline-primary">Next</a>
                                        <a href="?page={{ page_obj.paginator.num_pages }}" class="btn btn-outline-primary">Last &raquo;</a>
                                    {% endif %}
                                </span>
                            </div>
                                <!-- Paginator with Custom Styling -->
                        </div> 
                        <div class="modal custom-modal fade" id="delete_project" role="dialog">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-body">
                                        <div class="form-header">
                                            <h3>Delete Project</h3>
                                            <p>Are you sure you want to delete this project?</p>
                                        </div>
                                        <div class="modal-btn delete-action">
                                            <div class="row">
                                                <div class="col-6 mb-0">
                                                    <a href="javascript:void(0);" class="btn btn-primary continue-btn">Delete</a>
                                                </div>
                                                <div class="col-6 mb-0">
                                                    <a href="javascript:void(0);" data-dismiss="modal" class="btn btn-primary cancel-btn">Cancel</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                      
                    
                    </div>
                    <!--Recent Activity-->  
        </div>
    </div>
</div>
<!--Translate Tasks-->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const translatingButtons = document.querySelectorAll('.start-translating-btn');

    translatingButtons.forEach(button => {
    button.addEventListener('click', function(e) {
        e.preventDefault();

        if (this.classList.contains('disabled')) {
            Swal.fire({
                icon: 'info',
                title: 'Process in Progress',
                text: 'Please wait for the current operation to complete.'
            });
            return;
        }

        const taskId = this.getAttribute('data-task-id');
        const originalText = this.innerHTML;
        handleTranslation(this, taskId, originalText);
    });
});

    async function handleTranslation(button, taskId, originalText) {
    try {
        // Show loading state
        Swal.fire({
            title: 'Translation in Progress',
            html: 'Please wait while we process your request...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Disable button
        button.classList.add('disabled');
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Translating...';

        const response = await fetch(`/tasks/${taskId}/translate/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        // Close loading dialog
        Swal.close();

        if (!response.ok) {
            throw new Error(data.message || 'Translation process failed');
        }

        handleTranslationResponse(data, button, originalText);

    } catch (error) {
        console.error('Translation error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Translation Failed',
            text: error.message || 'An unexpected error occurred'
        });
        resetButton(button, originalText);
    }
}
    function handleTranslationResponse(response) {
    const data = response.details || {};
    
    let message = `
        <div class="translation-status">
            <p>${response.message}</p>
            ${data.reason ? `<p class="reason">${data.reason}</p>` : ''}
            
            <div class="stats">
                <p>Total businesses: ${data.total || 0}</p>
                <p>Pending: ${data.pending || 0}</p>
                <p>Reviewed: ${data.reviewed || 0}</p>
                <p>Discarded: ${data.discarded || 0}</p>
            </div>

            ${data.error_details && data.error_details.length > 0 ? `
                <div class="errors">
                    <h4>Issues Found:</h4>
                    <ul>
                        ${data.error_details.map(error => 
                            `<li>Business ${error.business_id}: ${error.issue}</li>`
                        ).join('')}
                    </ul>
                </div>
            ` : ''}
        </div>
    `;

    Swal.fire({
        icon: response.status === 'success' ? 'success' : 
            response.status === 'warning' ? 'warning' : 'error',
        title: response.status === 'success' ? 'Translation Complete' : 
            response.status === 'warning' ? 'Warning' : 'Translation Failed',
        html: message,
        confirmButtonText: 'OK'
    });
}
    
    function handleSuccess(data, button) {
    button.innerHTML = '<i class="fas fa-check"></i> Translation Complete';
    
    const taskId = button.getAttribute('data-task-id');
    const taskUrl = `/tasks/${taskId}/details/`; // Adjust this URL according to your routing

    Swal.fire({
        icon: 'success',
        title: 'Translation Successful',
        html: `
            <div class="translation-summary">
                ${createSuccessMessage(data)}
                <div class="mt-3">
                    <a href="${taskUrl}" class="btn btn-info btn-sm">
                        <i class="fas fa-eye"></i> View Task Details
                    </a>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Refresh Page',
        cancelButtonText: 'View Task',
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            location.reload();
        } else {
            window.location.href = taskUrl;
        }
    });
}

    function handleWarning(data, button, originalText) {
        button.innerHTML = originalText;
        button.classList.remove('disabled');

        Swal.fire({
            icon: 'warning',
            title: 'Cannot Proceed',
            html: createWarningMessage(data),
            confirmButtonText: 'OK'
        });
    }

    function handleError(data, button, originalText) {
        button.innerHTML = originalText;
        button.classList.remove('disabled');

        Swal.fire({
            icon: 'error',
            title: 'Translation Error',
            html: createErrorMessage(data),
            confirmButtonText: 'OK',
            showCancelButton: true,
            cancelButtonText: 'Report Issue'
        }).then((result) => {
            if (!result.isConfirmed) {
                reportIssue(data);
            }
        });
    }

    function handleUnknownStatus(data, button, originalText) {
        button.innerHTML = originalText;
        button.classList.remove('disabled');

        Swal.fire({
            icon: 'question',
            title: 'Unexpected Response',
            text: 'Received an unexpected response from the server.',
            confirmButtonText: 'OK'
        });
    }

    function createSuccessMessage(data) {
        return `
            <div class="translation-results">
                <p>${data.message || 'Translation completed successfully'}</p>
                ${data.details ? `
                    <div class="translation-details">
                        <p>Successfully processed: ${data.details.success || 0}</p>
                        <p>Failed: ${data.details.failed || 0}</p>
                        <p>Total: ${data.details.total || 0}</p>
                        ${data.details.status_updates?.pending_to_reviewed > 0 ? 
                            `<p>Updated from pending: ${data.details.status_updates.pending_to_reviewed}</p>` : ''}
                    </div>
                ` : ''}
            </div>
        `;
    }

    function createWarningMessage(data) {
        return `
            <div class="warning-message">
                <p>${data.message}</p>
                ${data.details ? `
                    <div class="status-breakdown">
                        <p>Current Status: ${data.details.current_status || 'Unknown'}</p>
                        ${data.details.suggestion ? `<p>Suggestion: ${data.details.suggestion}</p>` : ''}
                        <div class="business-stats">
                            <p>Total Businesses: ${data.details.total || 0}</p>
                            <p>Pending: ${data.details.pending || 0}</p>
                            <p>Reviewed: ${data.details.reviewed || 0}</p>
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }

    function createErrorMessage(data) {
        return `
            <div class="error-message">
                <p>${data.message}</p>
                ${data.details ? `
                    <div class="business-stats">
                        ${data.details.total ? `<p>Total Businesses: ${data.details.total}</p>` : ''}
                        ${data.details.pending ? `<p>Pending Review: ${data.details.pending}</p>` : ''}
                        ${data.details.reviewed ? `<p>Reviewed: ${data.details.reviewed}</p>` : ''}
                        ${data.details.discarded ? `<p>Discarded: ${data.details.discarded}</p>` : ''}
                    </div>
                ` : ''}
                ${data.suggestion ? `
                    <p class="suggestion">${data.suggestion}</p>
                ` : ''}
            </div>
        `;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function reportIssue(errorData) {
        console.log('Reporting issue:', errorData);
        // Implement your issue reporting logic here
        Swal.fire({
            icon: 'info',
            title: 'Issue Reported',
            text: 'The issue has been logged for investigation.',
            confirmButtonText: 'OK'
        });
    }
});
</script>
<!--Translate Tasks-->
    
<!--DataTable-->
<script>
$(document).ready(function() {
    // Setup - add a text input to each footer cell
    $('#task-activity thead tr:eq(1) th').each(function (i) {
        var title = $(this).text();
        if (title !== 'Select' && title !== 'Action') {
            $('input', this).on('keyup change', function () {
                if (table.column(i).search() !== this.value) {
                    table
                        .column(i)
                        .search(this.value)
                        .draw();
                }
            });
        }
    });

    // Initialize DataTable
    var table = $('#task-activity').DataTable({
        "pageLength": 24,
        "lengthChange": true,
        "searching": true,
        "ordering": true,
        "info": true,
        "autoWidth": false,
        orderCellsTop: true,
        fixedHeader: true
    });
});

</script>
<!--DataTable-->
 
<!--Delete tasks-->
<script>
    document.addEventListener('DOMContentLoaded', function() {
    const deleteButtons = document.querySelectorAll('.delete-task-btn');

    deleteButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const taskId = this.getAttribute('data-task-id');
            const row = this.closest('tr');

            Swal.fire({
                title: 'Are you sure?',
                text: "Do you really want to delete this task?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/tasks/${taskId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Remove the row from the table
                            row.remove();
                            Swal.fire('Deleted!', 'The task has been deleted.', 'success');
                        } else {
                            Swal.fire('Error!', 'An error occurred while deleting the task.', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        Swal.fire('Error!', 'An error occurred while deleting the task.', 'error');
                    });
                }
            });
        });
    });
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    });
</script>
<!--Delete tasks-->
{% endblock %}
