<!-- templates/feedbacks/feedback_list.html -->
{% extends 'base.html' %}
{% load static %}

{% block content %}
<style> .status-select {padding: 0.375rem 0.75rem;font-size: 0.875rem;border: 1px solid #ced4da;border-radius: 0.25rem;width: 100%;transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;}.status-select:focus {border-color: #80bdff;outline: 0;box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);}.status-select option {padding: 0.5rem;}.status-select[disabled] {background-color: #e9ecef;cursor: not-allowed;}.status-select option[value="INITIAL"] {color: #6c757d;}.status-select option[value="IN_PROGRESS"] {color: #007bff;}.status-select option[value="DONE"] {color: #28a745;}</style>
<div class="main-content project"> 
    <div class="row">
        <div class="col-12">
            <div class="page-title-wrapper">
                <h1 class="page-title">
                    <span class="title-icon">
                        <i class="fas fa-comments"></i>
                    </span>
                    <span class="title-text">Content Comments</span>
                </h1>
            </div>
        </div>
    </div>
 

    <div class="card">
        <div class="card-body">
            <table id="feedback-table" class="table table-striped">
                <thead>
                    <tr>
                        <th>Business</th>
                        <th>Content</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for feedback in feedbacks %}
                    <tr data-feedback-id="{{ feedback.id }}">
                        <td>{{ feedback.business.title }}</td>
                        <td>{{ feedback.content|truncatechars:100 }}</td>
                        <td>
                            <select class="form-select status-select" data-feedback-id="{{ feedback.id }}">
                                {% for status_code, status_label in status_choices %}
                                <option value="{{ status_code }}" {% if feedback.status == status_code %}selected{% endif %}>
                                    {{ status_label }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td data-order="{{ feedback.created_at|date:'Y-m-d H:i:s' }}">
                            {{ feedback.created_at|date:"M d, Y H:i" }}
                        </td>
                        <td data-order="{{ feedback.updated_at|date:'Y-m-d H:i:s' }}">
                            {{ feedback.updated_at|date:"M d, Y H:i" }}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info view-feedback" data-feedback-id="{{ feedback.id }}">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div> 
 
<script>
$(document).ready(function() {
    const table = $('#feedback-table').DataTable({
        order: [[3, 'desc']],
        pageLength: 25,
        responsive: true,
        columns: [
            { width: '20%' },
            { width: '30%' },
            { width: '15%' },
            { width: '15%' },
            { width: '15%' },
            { width: '5%' }
        ]
    });

    // Status Update Handler
    $('.status-select').change(function() {
        const feedbackId = $(this).data('feedback-id');
        const newStatus = $(this).val();
        const select = $(this);

        select.prop('disabled', true);

        fetch(`/feedbacks/${feedbackId}/update-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ status: newStatus })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                toastr.success('Status updated successfully');
                table.draw(false);
            } else {
                toastr.error(data.message || 'Error updating status');
                select.val(select.data('original-value'));
            }
        })
        .catch(error => {
            toastr.error('Error updating status');
            select.val(select.data('original-value'));
        })
        .finally(() => {
            select.prop('disabled', false);
        });
    });

    // View Feedback Handler
    $('.view-feedback').click(function() {
        const feedbackId = $(this).data('feedback-id');
        // Implement view feedback modal logic here
    });
});

// CSRF Token Helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
